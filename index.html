<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEAM NG·ªåC TR√ÇN - MAFC</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">

  <style>
    .avatar-green {
      background: linear-gradient(135deg, #16a34a, #34d399);
    }
    .card {
      background: #ffffff;
    }
    .notif-bell {
      position: relative;
      cursor: pointer;
      display: inline-block;
      font-size: 24px;
    }
    .notif-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 18px;
      height: 18px;
      text-align: center;
      border-radius: 50%;
      line-height: 18px;
    }
    .admin-content {
      transition: max-height 0.3s ease;
      overflow: hidden;
    }
    #loginNotifBox {
      display: none !important;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 md:py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 md:w-10 md:h-10 rounded-md avatar-green flex items-center justify-center text-white font-semibold text-sm">
          MAFC
        </div>

        <div>
          <div class="text-base md:text-lg font-semibold">TRANG H·ªñ TR·ª¢ CHECK B11</div>
          <div class="text-xs text-gray-500">Gi·∫£i ph√°p t·∫°m th·ªùi ‚Äì Hotline 0901450505 (Ms. Tr√¢n)</div>
        </div>
      </div>

      <div id="headerRight" class="text-sm text-gray-600 truncate max-w-xs md:max-w-md text-right">
        <span id="notifBell" class="notif-bell">
          üîî<span id="notifCount" class="notif-count">0</span>
        </span>
      </div>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="min-h-[calc(100vh-72px)] max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-8 flex flex-col md:flex-row gap-6 md:gap-8">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white border rounded-lg p-4 md:p-6 flex-shrink-0">

      <div class="flex items-center gap-3 mb-4 md:mb-6">
        <div id="sidebarAvatar" class="w-10 h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">?</div>

        <div class="min-w-0">
          <div id="sidebarName" class="font-semibold truncate">---</div>
          <div id="sidebarEmail" class="text-xs text-gray-500 truncate">---</div>
        </div>
      </div>

      <!-- MENU -->
      <nav class="space-y-2">
        <button id="navLookup" class="w-full text-left px-3 py-2 rounded-md bg-green-50 text-green-700 flex items-center gap-3">
          üîç Tra c·ª©u CIC
        </button>

        <button id="navHistory" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üìú L·ªãch s·ª≠ tra c·ª©u
        </button>

        <button id="navAdmin" class="hidden w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üõ°Ô∏è Trang Admin
        </button>
      </nav>

      <div class="mt-4 border-t pt-3">
        <button id="btnEditName" class="w-full text-left text-sm mb-2 px-2 py-2 rounded-md hover:bg-gray-100">
          ‚úèÔ∏è C·∫≠p nh·∫≠t h·ªç t√™n
        </button>

        <button id="btnLogout" class="w-full text-left text-sm text-red-600 px-2 py-2 rounded-md hover:bg-red-50">
          üö™ ƒêƒÉng xu·∫•t
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1">

      <!-- AUTH BOX -->
      <section id="authBox" class="mx-auto card rounded-lg shadow p-4 md:p-6 max-w-lg">
        <div id="authForms">

          <!-- SIGNUP FORM -->
          <div id="signupArea">
            <h3 class="text-lg md:text-xl font-semibold mb-3">ƒêƒÉng k√Ω t√†i kho·∫£n</h3>

            <form id="signupForm" class="space-y-2">
              <input id="signupName" class="w-full border rounded-md px-3 py-2" placeholder="H·ªç t√™n nh√¢n vi√™n" required />

              <input id="signupEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email" required />

              <input id="signupPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="M·∫≠t kh·∫©u" required />

              <input id="signupRepass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md">ƒêƒÉng k√Ω</button>

                <button id="showLoginBtn" class="flex-1 border rounded-md px-4 py-2">
                  ƒê√£ c√≥ t√†i kho·∫£n
                </button>
              </div>
            </form>
          </div>

          <!-- LOGIN FORM -->
          <div id="loginArea" class="hidden">
            <h3 class="text-lg md:text-xl font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>

            <form id="loginForm" class="space-y-2">
              <input id="loginEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email" required />

              <input id="loginPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="M·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md">ƒêƒÉng nh·∫≠p</button>

                <button id="showSignupBtn" class="flex-1 border rounded-md px-4 py-2">ƒêƒÉng k√Ω</button>
              </div>
            </form>
          </div>

        </div>
      </section>

      <!-- APP AREA -->
      <section id="appArea" class="hidden space-y-6">

        <!-- LOOKUP PAGE -->
        <div id="lookupPage" class="card rounded-lg p-4 md:p-6">

          <div class="mb-4 text-red-600 font-bold text-xs">
            üì¢ Th√¥ng b√°o tra c·ª©u B11<br>
            ‚Ä¢ Nh·∫≠p ƒë√∫ng h·ªç t√™n KH & CCCD 12 s·ªë<br>
            ‚Ä¢ Kh√¥ng check ƒë∆∞·ª£c s·ªë CMND c≈© 9 s·ªë<br>
            ‚Ä¢ K·∫øt qu·∫£ xem trong m·ª•c ‚ÄúL·ªãch s·ª≠ tra c·ª©u‚Äù
          </div>

          <h3 class="text-lg font-semibold mb-4">üîé G·ª≠i y√™u c·∫ßu tra c·ª©u B11</h3>

          <form id="lookupForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-7">
              <label class="text-sm text-gray-600">H·ªç v√† t√™n kh√°ch h√†ng</label>
              <input id="fullname" class="w-full border rounded-md px-3 py-2" required />
            </div>

            <div class="md:col-span-5">
              <label class="text-sm text-gray-600">S·ªë CCCD (12 s·ªë)</label>
              <input id="cccd" maxlength="12" class="w-full border rounded-md px-3 py-2" required />
            </div>

            <div class="md:col-span-12">
              <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-md w-full md:w-auto">
                G·ª≠i tra c·ª©u
              </button>
            </div>
          </form>

          <div id="lookupResult" class="mt-4 text-sm">Ch∆∞a c√≥ k·∫øt qu·∫£.</div>
        </div>

        <!-- HISTORY PAGE -->
        <div id="historyPage" class="card rounded-lg p-4 md:p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">üìú L·ªãch s·ª≠ tra c·ª©u c·ªßa b·∫°n</h3>
          <div id="historyList" class="space-y-2 text-sm">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="adminPage" class="card rounded-lg p-4 md:p-6 hidden">
          <h3 class="text-xl font-semibold mb-4">üõ°Ô∏è TRANG ADMIN ‚Äì TR·∫¢ K·∫æT QU·∫¢</h3>

          <div id="adminList" class="space-y-4 text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</div>

          <h3 class="text-lg font-semibold mt-8 mb-3">üë• Nh√¢n vi√™n ch·ªù duy·ªát</h3>
          <div id="pendingList" class="space-y-2 text-sm"></div>
        </div>

      </section>
    </main>
  </div>

  <!-- MODAL UPDATE NAME -->
  <div id="updateNameBox" class="fixed right-4 bottom-4 md:right-6 md:bottom-6 hidden z-50">
    <div class="bg-white p-3 rounded-lg shadow w-64">
      <div class="mb-2 text-sm font-medium">C·∫≠p nh·∫≠t h·ªç t√™n</div>

      <input id="updateNameInput" class="w-full border rounded-md px-3 py-2 mb-2" placeholder="H·ªç v√† t√™n m·ªõi" />

      <div class="flex gap-2">
        <button id="saveNameBtn" class="bg-green-600 text-white px-3 py-1 rounded-md">L∆∞u</button>
        <button id="cancelNameBtn" class="border px-3 py-1 rounded-md">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="mt-6 md:mt-8">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-4 text-center text-sm text-gray-500 border-t bg-white">
      ¬© 2025 ‚Äì Thi·∫øt k·∫ø b·ªüi Ms.Tr√¢n
    </div>
  </footer>
<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============================================================================
    FIREBASE CONFIG
============================================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDyksVWuBPVVbHix7u-OZmIh8nFu66uNFo",
  authDomain: "tracuucic-login.firebaseapp.com",
  projectId: "tracuucic-login",
  storageBucket: "tracuucic-login.appspot.com",
  messagingSenderId: "648747772689",
  appId: "1:648747772689:web:69da6e1534ed63efddbab0",
};

/* ============================================================================
    INIT FIREBASE
============================================================================ */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ============================================================================
    DOM ELEMENTS
============================================================================ */
const authBox        = document.getElementById("authBox");
const signupArea     = document.getElementById("signupArea");
const loginArea      = document.getElementById("loginArea");

const sidebarName    = document.getElementById("sidebarName");
const sidebarEmail   = document.getElementById("sidebarEmail");
const sidebarAvatar  = document.getElementById("sidebarAvatar");

const updateNameBox   = document.getElementById("updateNameBox");
const updateNameInput = document.getElementById("updateNameInput");
const saveNameBtn     = document.getElementById("saveNameBtn");
const cancelNameBtn   = document.getElementById("cancelNameBtn");

const navLookup  = document.getElementById("navLookup");
const navHistory = document.getElementById("navHistory");
const navAdmin   = document.getElementById("navAdmin");

const lookupPage  = document.getElementById("lookupPage");
const historyPage = document.getElementById("historyPage");
const adminPage   = document.getElementById("adminPage");

const historyList = document.getElementById("historyList");
const adminList   = document.getElementById("adminList");

const notifBell   = document.getElementById("notifBell");
const notifCount  = document.getElementById("notifCount");

const lookupResult = document.getElementById("lookupResult");

/* ============================================================================
    ADMIN EMAIL ‚Äì CH·ªà 1 EMAIL ƒê∆Ø·ª¢C QUY·ªÄN DUY·ªÜT USER
============================================================================ */
const ADMIN_EMAIL = "vothienbdn@gmail.com";

function isAdmin(user) {
  return user && user.email === ADMIN_EMAIL;
}

/* ============================================================================
    CHUY·ªÇN FORM LOGIN <-> SIGNUP
============================================================================ */
document.getElementById("showLoginBtn").addEventListener("click", e => {
  e.preventDefault();
  signupArea.classList.add("hidden");
  loginArea.classList.remove("hidden");
});

document.getElementById("showSignupBtn").addEventListener("click", e => {
  e.preventDefault();
  loginArea.classList.add("hidden");
  signupArea.classList.remove("hidden");
});

/* ============================================================================
    SIGNUP ‚Äì ƒê∆ØA USER V√ÄO users_pending
============================================================================ */
document.getElementById("signupForm").addEventListener("submit", async e => {
  e.preventDefault();

  const name   = signupName.value.trim();
  const email  = signupEmail.value.trim();
  const pass   = signupPass.value;
  const repass = signupRepass.value;

  if (!name || !email || !pass)
    return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");

  if (pass !== repass)
    return alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!");

  try {
    // T·∫°o t√†i kho·∫£n Firebase Authentication
    const userCred = await auth.createUserWithEmailAndPassword(email, pass);

    // Set displayName cho t√†i kho·∫£n
    await userCred.user.updateProfile({ displayName: name });

    // üî• Th√™m v√†o danh s√°ch USER CH·ªú DUY·ªÜT
    await db.collection("users_pending").doc(userCred.user.uid).set({
      uid: userCred.user.uid,
      name: name,
      email: email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("ƒêƒÉng k√Ω th√†nh c√¥ng! T√†i kho·∫£n ƒëang ch·ªù admin duy·ªát.");

    // Reset form + chuy·ªÉn sang giao di·ªán ƒëƒÉng nh·∫≠p
    signupForm.reset();
    signupArea.classList.add("hidden");
    loginArea.classList.remove("hidden");

  } catch (err) {
    alert("L·ªói ƒëƒÉng k√Ω: " + err.message);
  }
});
/* ============================================================================
    LOGIN ‚Äî CH·ªà USER ƒê∆Ø·ª¢C DUY·ªÜT M·ªöI ƒê∆Ø·ª¢C ƒêƒÇNG NH·∫¨P
============================================================================ */
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();

  const email = loginEmail.value.trim();
  const pass  = loginPass.value;

  try {
    const userCred = await auth.signInWithEmailAndPassword(email, pass);
    const user = userCred.user;

    // üî• KI·ªÇM TRA USER ƒê√É ƒê∆Ø·ª¢C DUY·ªÜT CH∆ØA
    const approvedRef = db.collection("approved_users").doc(user.uid);
    const approvedSnap = await approvedRef.get();

    if (!approvedSnap.exists) {
      alert("T√†i kho·∫£n c·ªßa b·∫°n CH∆ØA ƒë∆∞·ª£c admin duy·ªát. Vui l√≤ng li√™n h·ªá admin.");
      await auth.signOut();
      return;
    }

    // N·∫øu ƒë∆∞·ª£c duy·ªát ‚Üí cho login b√¨nh th∆∞·ªùng
    loginForm.reset();

  } catch (err) {
    alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
  }
});

/* ============================================================================
    LOGOUT
============================================================================ */
document.getElementById("btnLogout").addEventListener("click", async () => {
  await auth.signOut();
  alert("ƒê√£ ƒëƒÉng xu·∫•t!");
  location.reload();
});

/* ============================================================================
    C·∫¨P NH·∫¨T T√äN HI·ªÇN TH·ªä
============================================================================ */
document.getElementById("btnEditName").addEventListener("click", () => {
  const current = sidebarName.textContent !== "---" ? sidebarName.textContent : "";
  updateNameInput.value = current;
  updateNameBox.classList.remove("hidden");
});

cancelNameBtn.addEventListener("click", () => {
  updateNameBox.classList.add("hidden");
});

saveNameBtn.addEventListener("click", async () => {
  const newName = updateNameInput.value.trim();

  if (!newName) return alert("Vui l√≤ng nh·∫≠p t√™n m·ªõi!");

  try {
    await auth.currentUser.updateProfile({ displayName: newName });

    sidebarName.textContent = newName;
    sidebarAvatar.textContent = newName.charAt(0).toUpperCase();

    updateNameBox.classList.add("hidden");
    alert("ƒê√£ c·∫≠p nh·∫≠t t√™n!");

  } catch (err) {
    alert("L·ªói c·∫≠p nh·∫≠t t√™n: " + err.message);
  }
});

/* ============================================================================
    ƒêI·ªÄU H∆Ø·ªöNG TRANG (MENU)
============================================================================ */
navLookup.onclick = () => {
  lookupPage.classList.remove("hidden");
  historyPage.classList.add("hidden");
  adminPage.classList.add("hidden");
};

navHistory.onclick = () => {
  lookupPage.classList.add("hidden");
  historyPage.classList.remove("hidden");
  adminPage.classList.add("hidden");
};

navAdmin.onclick = () => {
  lookupPage.classList.add("hidden");
  historyPage.classList.add("hidden");
  adminPage.classList.remove("hidden");
};
/* ============================================================================
    NH√ÇN VI√äN ‚Äî G·ª¨I Y√äU C·∫¶U TRA C·ª®U B11
============================================================================ */
lookupForm.addEventListener("submit", async e => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");

  const customerName = fullname.value.trim();
  const cccdValue    = cccd.value.trim();

  if (!customerName || cccdValue.length !== 12)
    return alert("T√™n kh√°ch h√†ng ho·∫∑c CCCD kh√¥ng h·ª£p l·ªá!");

  lookupResult.innerHTML = "‚è≥ ƒêang g·ª≠i y√™u c·∫ßu...";

  try {
    await db.collection("tra_cuu_b11").add({
      uid: user.uid,
      employeeName: user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)",
      employeeEmail: user.email,
      customerName,
      cccd: cccdValue,
      ketQua: {},
      approved: true,   // d√†nh cho nh√¢n vi√™n ƒë√£ ƒë∆∞·ª£c duy·ªát
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    lookupResult.innerHTML = `
      <span class="text-green-600 font-semibold">ƒê√£ g·ª≠i th√†nh c√¥ng!</span>
    `;

    lookupForm.reset();

  } catch (err) {
    lookupResult.innerHTML = `
      <span class="text-red-600">L·ªói g·ª≠i y√™u c·∫ßu: ${err.message}</span>
    `;
  }
});


/* ============================================================================
    NH√ÇN VI√äN ‚Äî L·ªäCH S·ª¨ TRA C·ª®U REALTIME + N√öT X√ìA
============================================================================ */

let unsubHistory = null;
let seenResultIDs = new Set();
let newNotifCount = 0;

function startHistoryListener() {
  const user = auth.currentUser;
  if (!user) return;

  if (unsubHistory) unsubHistory(); // h·ªßy listener c≈©

  unsubHistory = db.collection("tra_cuu_b11")
    .orderBy("createdAt", "desc")
    .limit(200)
    .onSnapshot(snapshot => {

      historyList.innerHTML = "";

      const items = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.uid === user.uid) items.push({ id: doc.id, ...data });
      });

      if (!items.length) {
        historyList.innerHTML = `
          <div class="text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ tra c·ª©u.</div>
        `;
        return;
      }

      items.forEach(item => {
        const time = item.createdAt?.toDate()?.toLocaleString() || "";
        const hasResult = item.ketQua && Object.keys(item.ketQua).length > 0;

        const div = document.createElement("div");
        div.className = "p-3 border rounded-md bg-white";

        div.innerHTML = `
          <div class="font-semibold">${item.customerName}</div>
          <div class="text-xs text-gray-500">CCCD: ${item.cccd} ‚Äî ${time}</div>

          <div class="mt-1">
            ${
              hasResult
              ? `<span class="text-green-600 font-bold">ƒê√£ c√≥ k·∫øt qu·∫£</span>`
              : `<span class="text-blue-600 font-semibold">ƒêang x·ª≠ l√Ω...</span>`
            }
          </div>

          ${
            hasResult
            ? `
              <div class="text-sm mt-2 bg-green-50 p-2 rounded">
                ‚Ä¢ Quan h·ªá TCTD: ${item.ketQua.tctd || ""}<br>
                ‚Ä¢ N·ª£ x·∫•u: ${item.ketQua.noXau || ""}<br>
                ‚Ä¢ N·ª£ ch√∫ √Ω: ${item.ketQua.noChuY || ""}<br>
                ‚Ä¢ T·ªïng d∆∞ n·ª£: ${item.ketQua.tongDuNo || ""}<br>
                ‚Ä¢ Ghi ch√∫: ${item.ketQua.ghiChu || ""}
              </div>
            `
            : ""
          }

          <button data-del="${item.id}" 
                  class="deleteBtn mt-2 bg-red-600 text-white px-3 py-1 rounded text-xs">
            ‚ùå X√≥a
          </button>
        `;

        historyList.appendChild(div);
      });

      attachDeleteButtons();
    });
}


/* ============================================================================
    N√öT X√ìA ‚Äî NH√ÇN VI√äN ƒê∆Ø·ª¢C QUY·ªÄN X√ìA Y√äU C·∫¶U M√åNH T·∫†O
============================================================================ */
function attachDeleteButtons() {
  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-del");

      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c n√†y?")) return;

      try {
        await db.collection("tra_cuu_b11").doc(id).delete();
        alert("ƒê√£ x√≥a!");
      } catch (err) {
        alert("L·ªói khi x√≥a: " + err.message);
      }
    };
  });
}
/* ============================================================================
    ADMIN ‚Äî LOAD DANH S√ÅCH Y√äU C·∫¶U REALTIME
============================================================================ */
let unsubAdmin = null;

function startAdminListener() {
  const user = auth.currentUser;
  if (!isAdmin(user)) return; // ch·ªâ admin xem ƒë∆∞·ª£c

  if (unsubAdmin) unsubAdmin();

  unsubAdmin = db.collection("tra_cuu_b11")
    .orderBy("createdAt", "desc")
    .limit(300)
    .onSnapshot(snapshot => {

      adminList.innerHTML = "";

      snapshot.forEach(doc => {
        const item = doc.data();
        const id = doc.id;
        const time = item.createdAt?.toDate()?.toLocaleString() || "";
        const hasResult = item.ketQua && Object.keys(item.ketQua).length > 0;

        const block = document.createElement("div");
        block.className = "border rounded-lg p-3 bg-white";

        block.innerHTML = `
          <!-- TI√äU ƒê·ªÄ (CLICK ƒê·ªÇ M·ªû ACCORDION) -->
          <button class="w-full text-left font-semibold text-lg mb-2 flex justify-between items-center admin-toggle">
            ${item.customerName}
            ${hasResult ? "‚úÖ" : "‚è≥"}
          </button>

          <!-- N·ªòI DUNG ACCORDION -->
          <div class="admin-content max-h-0">

            <div class="text-sm text-gray-600 mb-1">
              CCCD: ${item.cccd} ‚Ä¢ G·ª≠i l√∫c: ${time}
            </div>

            <div class="text-sm text-gray-500 mb-3">
              Nh√¢n vi√™n: ${item.employeeName} ‚Ä¢ ${item.employeeEmail}
            </div>

            <!-- FORM NH·∫¨P K·∫æT QU·∫¢ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

              <div>
                <label class="text-sm font-semibold">Quan h·ªá t·∫°i TCTD</label>
                <input data-id="${id}" data-field="tctd"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.tctd || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">N·ª£ x·∫•u</label>
                <input data-id="${id}" data-field="noXau"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.noXau || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">N·ª£ ch√∫ √Ω</label>
                <input data-id="${id}" data-field="noChuY"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.noChuY || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">T·ªïng d∆∞ n·ª£</label>
                <input data-id="${id}" data-field="tongDuNo"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.tongDuNo || ""}">
              </div>

              <div class="md:col-span-2">
                <label class="text-sm font-semibold">Ghi ch√∫</label>
                <textarea data-id="${id}" data-field="ghiChu"
                          class="admin-input w-full border px-3 py-2 rounded">${item.ketQua?.ghiChu || ""}</textarea>
              </div>

            </div>

            <!-- N√öT L∆ØU -->
            <button data-save="${id}"
                    class="saveKetQua mt-4 bg-green-600 text-white px-4 py-2 rounded">
              üíæ Tr·∫£ K·∫øt Qu·∫£
            </button>

          </div>
        `;

        adminList.appendChild(block);
      });

      attachAdminEvents();
    });
}

/* ============================================================================
    ADMIN ‚Äî B·∫ÆT S·ª∞ KI·ªÜN ACCORDION + L∆ØU D·ªÆ LI·ªÜU
============================================================================ */
function attachAdminEvents() {

  /* -------------------------
      ACCORDION M·ªû / THU G·ªåN
  ----------------------------*/
  document.querySelectorAll(".admin-toggle").forEach(btn => {
    btn.onclick = () => {
      const content = btn.nextElementSibling;

      if (content.style.maxHeight) {
        content.style.maxHeight = null;
      } else {
        content.style.maxHeight = content.scrollHeight + "px";
      }
    };
  });

  /* -------------------------
      N√öT L∆ØU K·∫æT QU·∫¢ CIC
  ----------------------------*/
  document.querySelectorAll(".saveKetQua").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-save");

      const inputs = document.querySelectorAll(`.admin-input[data-id="${id}"]`);

      const ketQua = {};
      inputs.forEach(ip => {
        ketQua[ip.getAttribute("data-field")] = ip.value.trim();
      });

      try {
        await db.collection("tra_cuu_b11").doc(id).update({ ketQua });
        alert("ƒê√£ l∆∞u k·∫øt qu·∫£ th√†nh c√¥ng!");

      } catch (err) {
        alert("L·ªói l∆∞u k·∫øt qu·∫£: " + err.message);
      }
    };
  });
}
/* ============================================================================
    AUTH STATE LISTENER ‚Äî QU·∫¢N L√ù TO√ÄN H·ªÜ TH·ªêNG
============================================================================ */
auth.onAuthStateChanged(async user => {

  if (user) {
    /* ===========================
         USER ƒê√É LOGIN
    ============================ */
    authBox.classList.add("hidden");
    appArea.classList.remove("hidden");

    // C·∫≠p nh·∫≠t sidebar
    const name = user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)";
    sidebarName.textContent = name;
    sidebarEmail.textContent = user.email;
    sidebarAvatar.textContent = name.charAt(0).toUpperCase();

    /* ===========================
         KI·ªÇM TRA ƒê√É ƒê∆Ø·ª¢C DUY·ªÜT ?
    ============================ */
    const approveRef = db.collection("approved_users").doc(user.uid);
    const approveSnap = await approveRef.get();

    if (!approveSnap.exists) {
      // ‚ùå Kh√¥ng ƒë∆∞·ª£c duy·ªát ‚Üí c·∫•m truy c·∫≠p
      appArea.classList.add("hidden");
      authBox.classList.remove("hidden");
      alert("T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c duy·ªát. Vui l√≤ng li√™n h·ªá admin!");
      await auth.signOut();
      return;
    }

    /* ===========================
         PH√ÇN QUY·ªÄN ADMIN
    ============================ */
    if (isAdmin(user)) {
      navAdmin.classList.remove("hidden");
      startAdminListener();   // b·∫Øt ƒë·∫ßu theo d√µi y√™u c·∫ßu CIC
    } else {
      navAdmin.classList.add("hidden");
    }

    /* ===========================
         RESET TH√îNG B√ÅO üîî
    ============================ */
    seenResultIDs.clear();
    newNotifCount = 0;
    notifCount.textContent = "0";

    /* ===========================
         L·ªäCH S·ª¨ TRA C·ª®U REALTIME
    ============================ */
    startHistoryListener();

  } else {
    /* ===========================
         USER ƒêƒÇNG XU·∫§T HO·∫∂C CH∆ØA LOGIN
    ============================ */
    authBox.classList.remove("hidden");
    appArea.classList.add("hidden");

    sidebarName.textContent = "---";
    sidebarEmail.textContent = "---";
    sidebarAvatar.textContent = "?";
    notifCount.textContent = "0";

    if (unsubHistory) unsubHistory();
    if (unsubAdmin) unsubAdmin();
  }

});
