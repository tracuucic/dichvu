<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra cứu CIC - B11T</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    .avatar-green { background: linear-gradient(135deg,#16a34a,#34d399); }
    .card { background: #ffffff; }
    .notif-bell { position: relative; cursor: pointer; display: inline-block; font-size: 24px; }
    .notif-count { position: absolute; top: -6px; right: -6px; background: red; color: white; font-size: 12px; font-weight: bold; width: 18px; height: 18px; text-align: center; border-radius: 50%; line-height: 18px; }
    /* Centered login notification */
    #loginNotifBox { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #facc15; border: 2px solid #eab308; border-radius: 8px; padding: 16px 24px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; font-weight: bold; color: #000; animation: fadein 0.5s; }
    #loginNotifBox button { margin-top: 10px; background: #34d399; color: white; padding: 4px 12px; border: none; border-radius: 4px; cursor: pointer; }
    @keyframes fadein { from {opacity:0;} to {opacity:1;} }

    /* Modal */
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { background: white; width: 360px; max-width:95%; border-radius:8px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 md:py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 md:w-10 md:h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">B11</div>
        <div>
          <div class="text-base md:text-lg font-semibold">Tra cứu CIC - B11T</div>
          <div class="text-xs text-gray-500">Giải Pháp Tạm Thời-Call:0964307247</div>
        </div>
      </div>
      <div id="headerRight" class="text-sm text-gray-600 truncate max-w-xs md:max-w-md text-right">
        <span id="notifBell" class="notif-bell">🔔<span id="notifCount" class="notif-count">0</span></span>
      </div>
    </div>
  </header>

  <div class="min-h-[calc(100vh-72px)] max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-8 flex flex-col md:flex-row gap-6 md:gap-8">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white border rounded-lg p-4 md:p-6 flex-shrink-0">
      <div class="flex items-center gap-3 mb-4 md:mb-6">
        <div class="w-10 h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">P</div>
        <div class="min-w-0">
          <div id="sidebarName" class="font-semibold truncate">---</div>
          <div id="sidebarEmail" class="text-xs text-gray-500 truncate">---</div>
        </div>
      </div>

      <nav class="space-y-2">
        <button id="navLookup" class="w-full text-left px-3 py-2 rounded-md bg-green-50 text-green-700 flex items-center gap-3">🔍 Tra cứu CIC</button>
        <button id="navHistory" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">📜 Lịch sử tra cứu</button>
      </nav>

      <div class="mt-4 border-t pt-3">
        <button id="btnEditName" class="w-full text-left text-sm mb-2 px-2 py-2 rounded-md hover:bg-gray-100">✏️ Cập nhật họ tên</button>
        <button id="btnLogout" class="w-full text-left text-sm text-red-600 px-2 py-2 rounded-md hover:bg-red-50">🚪 Đăng xuất</button>

        <!-- NẠP TIỀN -->
        <button id="btnTopup" class="w-full mt-3 text-left text-sm px-2 py-2 rounded-md bg-yellow-50 hover:bg-yellow-100">💰 NẠP TIỀN</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1">

      <!-- LOGIN / SIGNUP BOX -->
      <section id="authBox" class="mx-auto card rounded-lg shadow p-4 md:p-6 max-w-lg">
        <div id="authForms">
          <!-- Signup -->
          <div id="signupArea">
            <h3 class="text-lg md:text-xl font-semibold mb-3">Đăng ký tài khoản</h3>
            <form id="signupForm" class="space-y-2">
              <input id="signupName" class="w-full border rounded-md px-3 py-2" placeholder="Họ tên nhân viên" required />
              <input id="signupEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email" required />
              <input id="signupPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="Mật khẩu" required />
              <input id="signupRepass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="Nhập lại mật khẩu" required />
              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md">Đăng ký</button>
                <button id="showLoginBtn" class="flex-1 border rounded-md px-4 py-2">Đã có tài khoản</button>
              </div>
            </form>
          </div>

          <!-- Login -->
          <div id="loginArea" class="hidden">
            <h3 class="text-lg md:text-xl font-semibold mb-3">Đăng nhập</h3>
            <form id="loginForm" class="space-y-2">
              <input id="loginEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email" required />
              <input id="loginPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="Mật khẩu" required />
              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md">Đăng nhập</button>
                <button id="showSignupBtn" class="flex-1 border rounded-md px-4 py-2">Đăng ký</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- CONTROLLED PAGES -->
      <section id="appArea" class="hidden space-y-6">
        <!-- Lookup page -->
        <div id="lookupPage" class="card rounded-lg p-4 md:p-6">

          <!-- THÔNG BÁO CHỮ ĐỎ, KHÔNG NỀN -->
          <div class="mb-4 text-red-600 font-bold text-xs">
            📢 Thông báo thời gian tra cứu B11- <br> 
            Tra cứu trong giờ hành chính: Kết quả từ 30 phút đến 1 tiếng- <br>
            Tra cứu sau giờ hành chính: Có thể chậm từ 2 - 4 tiếng hoặc sáng hôm sau. VUI LÒNG GHI CHÍNH XÁC TÊN KHÁCH HÀNG, KHÔNG CHECK ĐC SỐ CMND CŨ NHÉ.<br>
            Hiện tại mẫu B11T phải check qua bên Đối tác trả thủ công nên không thể nhanh như hệ thống tự động S37 luồng cũ, nên AE KHÓ TÍNH CẦN ĐỌC KỸ, CÂN NHẮC trước khi check, nếu thấy phù hợp thì dùng. Không có giải pháp nào luôn hoàn hảo, chỉ có giải pháp phù hợp nhất theo tình hình thực tế.<br>
            *** KẾT QUẢ TRA CỨU CIC NẰM Ở MỤC "Lịch Sử Tra Cứu" ***
          </div>

          <h3 class="text-lg font-semibold mb-4">🔎 Tra cứu B11</h3>
          <form id="lookupForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-7">
              <label class="text-sm text-gray-600">Họ và tên khách hàng</label>
              <input id="fullname" class="w-full border rounded-md px-3 py-2" placeholder="Nguyễn Văn A" required />
            </div>
            <div class="md:col-span-5">
              <label class="text-sm text-gray-600">Số CCCD (12 số)</label>
              <input id="cccd" maxlength="12" class="w-full border rounded-md px-3 py-2" placeholder="123456789012" required />
            </div>
            <div class="md:col-span-12">
              <button id="btnTraCuu" type="submit" class="bg-green-600 text-white px-5 py-2 rounded-md w-full md:w-auto">Tra cứu</button>
            </div>
          </form>
          <div id="lookupResult" class="mt-4 text-sm text-gray-700">Chưa có kết quả.</div>
        </div>

        <!-- History page -->
        <div id="historyPage" class="card rounded-lg p-4 md:p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">📜 Lịch sử tra cứu của bạn</h3>
          <div id="historyList" class="space-y-2 text-sm text-gray-700">Chưa có lịch sử.</div>
        </div>
      </section>

    </main>
  </div>

  <!-- Topup Modal -->
  <div id="topupBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3 class="text-lg font-semibold mb-3">Nạp tiền - Thêm lượt tra cứu</h3>
      <div class="mb-3">
        <img id="qrImg" src="" alt="QR" class="w-full rounded-md mb-2" />
        <div class="text-sm text-gray-600">💳 Tên ngân hàng: <strong>TPBank</strong></div>
        <div class="text-sm text-gray-600">👤 Chủ tài khoản: <strong>VO QUOC THIEN</strong></div>
        <div class="text-sm text-gray-600">🔢 Số tài khoản: <strong>0964307247</strong></div>
      </div>

      <label class="text-sm text-gray-600">Số tiền (VND) — tối thiểu 100.000đ</label>
      <input id="topupAmount" type="number" min="100000" step="10000" value="100000" class="w-full border rounded-md px-3 py-2 mb-2" />

      <label class="text-sm text-gray-600">Nội dung chuyển khoản (mẫu)</label>
      <input id="topupCode" class="w-full border rounded-md px-3 py-2 mb-3" readonly />

      <div class="flex gap-2">
        <button id="confirmTopupBtn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md">ĐÃ THANH TOÁN 💸</button>
        <button id="closeTopupBtn" class="flex-1 border px-4 py-2 rounded-md">Đóng</button>
      </div>
      <p class="mt-2 text-xs text-gray-500">Sau khi nhấn "ĐÃ THANH TOÁN" hệ thống sẽ ghi "Chờ duyệt". Admin duyệt xong mới cộng lượt.</p>
    </div>
  </div>

  <!-- Update name modal -->
  <div id="updateNameBox" class="fixed right-4 bottom-4 md:right-6 md:bottom-6 hidden z-50">
    <div class="bg-white p-3 rounded-lg shadow w-64">
      <div class="mb-2 text-sm font-medium">Cập nhật họ tên</div>
      <input id="updateNameInput" class="w-full border rounded-md px-3 py-2 mb-2" placeholder="Họ và tên mới" />
      <div class="flex gap-2">
        <button id="saveNameBtn" class="bg-green-600 text-white px-3 py-1 rounded-md">Lưu</button>
        <button id="cancelNameBtn" class="border px-3 py-1 rounded-md">Hủy</button>
      </div>
    </div>
  </div>

  <!-- Centered login notification -->
  <div id="loginNotifBox">
    📢 Chào mừng bạn đến với hệ thống Tra cứu B11T!<br>
    Hiện tại tra B11T chậm nên bạn vui lòng kiên nhẫn.<br>
    Kết quả xem ở phần Lịch Sử Tra Cứu.<br>
    Chúc bạn 1 ngày làm việc thành công! VQT
    <button id="closeLoginNotifBtn">Đóng</button>
  </div>

  <!-- Footer -->
  <footer class="mt-6 md:mt-8">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-4 text-center text-sm text-gray-500 border-t bg-white">
      © Copyright 2025 VQT. Giải Pháp Vay Tiêu Dùng Uy Tín &amp; Linh Hoạt
    </div>
  </footer>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---------- Cấu hình: thay 2 giá trị này ----------
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIPFx6NVWx1kb1Se9LkmruBXB22_ULmVTg1ukmGN8UUZ4IWCF6R0CbD3M5uTrPSobs/exec";
    const QR_IMAGE_URL = "https://drive.google.com/uc?export=view&id=1JZ9suny0blMSQ44As-Ir4AO-3-KCPD-o";
    // ------------------------------------------------

    const firebaseConfig = {
      apiKey: "AIzaSyDyksVWuBPVVbHix7u-OZmIh8nFu66uNFo",
      authDomain: "tracuucic-login.firebaseapp.com",
      projectId: "tracuucic-login",
      storageBucket: "tracuucic-login.firebasestorage.app",
      messagingSenderId: "648747772689",
      appId: "1:648747772689:web:69da6e1534ed63efddbab0",
      measurementId: "G-ELVGHX2GL4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const authBox = document.getElementById('authBox');
    const signupArea = document.getElementById('signupArea');
    const loginArea = document.getElementById('loginArea');
    const appArea = document.getElementById('appArea');
    const lookupPage = document.getElementById('lookupPage');
    const historyPage = document.getElementById('historyPage');
    const historyList = document.getElementById('historyList');
    const lookupResult = document.getElementById('lookupResult');
    const headerRight = document.getElementById('headerRight');
    const sidebarName = document.getElementById('sidebarName');
    const sidebarEmail = document.getElementById('sidebarEmail');
    const btnNavLookup = document.getElementById('navLookup');
    const btnNavHistory = document.getElementById('navHistory');
    const btnEditName = document.getElementById('btnEditName');
    const updateNameBox = document.getElementById('updateNameBox');
    const updateNameInput = document.getElementById('updateNameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const cancelNameBtn = document.getElementById('cancelNameBtn');

    const notifBell = document.getElementById('notifBell');
    const notifCount = document.getElementById('notifCount');
    let newNotifCount = 0;
    let lastSeenKetQuaIds = new Set();
    let unsubscribeHistory = null;

    const loginNotifBox = document.getElementById('loginNotifBox');
    const closeLoginNotifBtn = document.getElementById('closeLoginNotifBtn');

    // Topup modal elements
    const btnTopup = document.getElementById('btnTopup');
    const topupBackdrop = document.getElementById('topupBackdrop');
    const qrImg = document.getElementById('qrImg');
    const topupAmount = document.getElementById('topupAmount');
    const topupCode = document.getElementById('topupCode');
    const confirmTopupBtn = document.getElementById('confirmTopupBtn');
    const closeTopupBtn = document.getElementById('closeTopupBtn');

    // Utility - random code
    function genCode(){
      const n = Math.floor(1000 + Math.random()*9000);
      return "NAP" + n;
    }

    // Show/hide auth forms
    document.getElementById('showLoginBtn').addEventListener('click', e => { e.preventDefault(); signupArea.classList.add('hidden'); loginArea.classList.remove('hidden'); });
    document.getElementById('showSignupBtn').addEventListener('click', e => { e.preventDefault(); loginArea.classList.add('hidden'); signupArea.classList.remove('hidden'); });

    // Signup
    document.getElementById('signupForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const pass = document.getElementById('signupPass').value;
      const repass = document.getElementById('signupRepass').value;
      if (!name || !email || !pass) { alert('Vui lòng nhập đủ thông tin'); return; }
      if (pass !== repass) { alert('Mật khẩu nhập lại không khớp'); return; }
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(userCred.user, { displayName: name });
        alert('Đăng ký thành công — vui lòng đăng nhập');
        document.getElementById('signupForm').reset();
        loginArea.classList.remove('hidden'); signupArea.classList.add('hidden');
      } catch (err) { alert('Lỗi đăng ký: ' + err.message); }
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      try { await signInWithEmailAndPassword(auth, email, pass); document.getElementById('loginForm').reset(); }
      catch (err) { alert('Lỗi đăng nhập: ' + err.message); }
    });

    // Logout
    document.getElementById('btnLogout').addEventListener('click', async () => { await signOut(auth); if (unsubscribeHistory) unsubscribeHistory(); });

    // Nav
    btnNavLookup.addEventListener('click', () => { lookupPage.classList.remove('hidden'); historyPage.classList.add('hidden'); });
    btnNavHistory.addEventListener('click', () => { lookupPage.classList.add('hidden'); historyPage.classList.remove('hidden'); startHistoryListener(); });

    // Edit name
    btnEditName.addEventListener('click', () => { updateNameInput.value = sidebarName.textContent==='---'?'':sidebarName.textContent; updateNameBox.classList.remove('hidden'); });
    cancelNameBtn.addEventListener('click', () => updateNameBox.classList.add('hidden'));
    saveNameBtn.addEventListener('click', async () => {
      const newName = updateNameInput.value.trim();
      if (!newName) return alert('Nhập họ tên mới');
      try {
        await updateProfile(auth.currentUser, { displayName: newName });
        sidebarName.textContent = newName;
        headerRight.textContent = newName + ' • ' + (auth.currentUser.email || '');
        updateNameBox.classList.add('hidden');
        alert('Cập nhật thành công');
      } catch (err) { alert('Lỗi cập nhật: ' + err.message); }
    });

    // Topup modal handling
    btnTopup.addEventListener('click', () => {
      qrImg.src = QR_IMAGE_URL;
      topupBackdrop.style.display = 'flex';
      topupCode.value = genCode();
      topupAmount.value = 100000;
    });
    closeTopupBtn.addEventListener('click', () => { topupBackdrop.style.display = 'none'; });

    confirmTopupBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if(!user) { alert('Vui lòng đăng nhập trước khi nạp'); return; }
      const hoTen = user.displayName || '(Chưa cập nhật)';
      const soTien = Number(topupAmount.value) || 0;
      if(soTien < 100000){ alert('Số tiền tối thiểu 100.000đ'); return; }
      const maNap = topupCode.value || genCode();
      const luotCheck = Math.floor(soTien / 10000); // 100k = 10 lượt

      confirmTopupBtn.disabled = true;
      confirmTopupBtn.textContent = 'Đang gửi...';
      try{
        const resp = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            type: 'topup',
            hoTen, soTien, maNap, luotCheck, trangThai: 'Chờ duyệt'
          })
        });
        const j = await resp.json();
        if(j.status === 'ok'){
          alert('Đã ghi nhận nạp — trạng thái: Chờ duyệt. Admin duyệt xong sẽ cộng lượt.');
          topupBackdrop.style.display = 'none';
        } else {
          alert('Lỗi nạp: ' + (j.message || JSON.stringify(j)));
        }
      } catch(err){
        alert('Lỗi gửi nạp tiền: ' + err.message + '\nKiểm tra lại URL Apps Script hoặc quyền truy cập (deploy).');
      } finally {
        confirmTopupBtn.disabled = false;
        confirmTopupBtn.textContent = 'ĐÃ THANH TOÁN 💸';
      }
    });

    // Lookup submit: trước hết gọi apps script để trừ 1 lượt theo tên nhân viên
    document.getElementById('lookupForm').addEventListener('submit', async e => {
      e.preventDefault();
      const customerName = document.getElementById('fullname').value.trim();
      const cccd = document.getElementById('cccd').value.trim();
      if (!customerName || cccd.length !== 12) { alert('Nhập họ tên & CCCD 12 chữ số'); return; }

      const user = auth.currentUser;
      if (!user) { alert('Vui lòng đăng nhập'); return; }
      const hoTenNV = user.displayName || '(Chưa cập nhật)';

      lookupResult.innerHTML = '⏳ Kiểm tra lượt...';
      // gọi Apps Script để trừ lượt
      try {
        const r = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ type: 'useCheck', hoTen: hoTenNV })
        });
        const jr = await r.json();
        if(jr.status === 'ok'){
          // đã trừ 1 lượt thành công -> gửi yêu cầu tra cứu vào Firestore như trước
          lookupResult.innerHTML = '⏳ Đang gửi dữ liệu tra cứu...';
          try {
            await addDoc(collection(db, 'tra_cuu_b11'), {
              uid: user.uid,
              customerName,
              cccd,
              ketQua: "",
              employeeName: hoTenNV,
              createdAt: serverTimestamp()
            });
            lookupResult.innerHTML = `<span class="text-green-600 font-semibold">Đã gửi thành công. Đã trừ 1 lượt.</span>`;
            document.getElementById('lookupForm').reset();
          } catch (err) {
            lookupResult.innerHTML = `<span class="text-red-600">Lỗi gửi tra cứu: ${err.message}</span>`;
          }
        } else if(jr.status === 'no_check'){
          lookupResult.innerHTML = `<span class="text-red-600">🔒 Hết lượt tra cứu — vui lòng nạp thêm!</span>`;
          alert('Bạn đã hết lượt. Vui lòng nạp thêm trước khi tra cứu.');
        } else {
          lookupResult.innerHTML = `<span class="text-red-600">Lỗi: ${jr.message || JSON.stringify(jr)}</span>`;
        }
      } catch(err){
        lookupResult.innerHTML = `<span class="text-red-600">Lỗi kết nối: ${err.message}</span>`;
        alert('Lỗi kết nối tới server (Apps Script). Kiểm tra URL và quyền truy cập (deploy).');
      }
    });

    // Realtime history (Firestore)
    function startHistoryListener() {
      if (unsubscribeHistory) unsubscribeHistory();
      const user = auth.currentUser;
      if (!user) return;
      const q = query(collection(db, 'tra_cuu_b11'), orderBy('createdAt','desc'), limit(100));

      unsubscribeHistory = onSnapshot(q, snapshot => {
        const items = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          if(d.uid === user.uid) items.push(d);
        });

        if(!items.length){ historyList.innerHTML='<div>Chưa có lịch sử tra cứu.</div>'; return; }

        historyList.innerHTML='';
        items.forEach(d=>{
          const t=d.createdAt&&d.createdAt.toDate?d.createdAt.toDate().toLocaleString():'';
          const item=document.createElement('div');
          item.className='p-3 border rounded-md';
          item.innerHTML=`<div class="font-medium">${d.customerName}</div>
            <div class="text-xs text-gray-500">CCCD: ${d.cccd} — ${t}</div>
            <div class="text-sm text-blue-600">Kết quả: ${d.ketQua || "Chưa có"}</div>
            <div class="text-xs text-gray-400">Nhân viên: ${d.employeeName || ''}</div>`;
          historyList.appendChild(item);
        });
      });
    }

    // Bell click: reset & open history
    notifBell.addEventListener('click', () => {
      newNotifCount = 0;
      notifCount.textContent = '0';
      lookupPage.classList.add('hidden');
      historyPage.classList.remove('hidden');
      startHistoryListener();
    });

    // Close login notification
    closeLoginNotifBtn.addEventListener('click', () => { loginNotifBox.style.display = 'none'; });

    // Auth state
    onAuthStateChanged(auth,user=>{
      if(user){
        authBox.classList.add('hidden'); appArea.classList.remove('hidden');
        const name=user.displayName||'(Chưa cập nhật)';
        sidebarName.textContent=name; sidebarEmail.textContent=user.email||'';
        headerRight.textContent=name + ' • ' + (user.email||'');
        lastSeenKetQuaIds.clear();
        startHistoryListener();

        // Show centered login notification shortly
        loginNotifBox.style.display = 'block';
        setTimeout(()=>{ loginNotifBox.style.display = 'none'; }, 4000);
      }else{
        authBox.classList.remove('hidden'); appArea.classList.add('hidden');
        headerRight.textContent=''; sidebarName.textContent='---'; sidebarEmail.textContent='---';
        if(unsubscribeHistory) unsubscribeHistory();
      }
    });
  </script>
</body>
</html>
