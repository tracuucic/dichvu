<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang T·ªïng H·ª£p</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">

  <style>
    .avatar-green {
      background: linear-gradient(135deg, #16a34a, #34d399);
    }
    .card { background: #ffffff; }

    .notif-bell {
      position: relative;
      cursor: pointer;
      display: inline-block;
      font-size: 24px;
    }
    .notif-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 18px;
      height: 18px;
      text-align: center;
      border-radius: 50%;
      line-height: 18px;
    }

    /* ·∫®n popup welcome */
    #loginNotifBox { display: none !important; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 md:py-4 flex items-center justify-between gap-4">

      <div class="flex items-center gap-3">
        <div class="w-9 h-9 md:w-10 md:h-10 rounded-md avatar-green flex items-center justify-center text-white font-semibold text-sm">
          MAFC
        </div>

        <div>
          <div class="text-base md:text-lg font-semibold">TRANG T·ªîNG H·ª¢P</div>
          <div class="text-xs text-gray-500">Gi·∫£i Ph√°p T·∫°m Th·ªùi - Hotline: 0964307247</div>
        </div>
      </div>

      <div id="headerRight" class="text-sm text-gray-600 truncate max-w-xs md:max-w-md text-right">
        <span id="notifBell" class="notif-bell">
          üîî<span id="notifCount" class="notif-count">0</span>
        </span>
      </div>

    </div>
  </header>

  <!-- LAYOUT -->
  <div class="min-h-[calc(100vh-72px)] max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-8 flex flex-col md:flex-row gap-6 md:gap-8">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white border rounded-lg p-4 md:p-6 flex-shrink-0">
      <div class="flex items-center gap-3 mb-4 md:mb-6">

        <div id="sidebarAvatar"
             class="w-10 h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">?</div>

        <div class="min-w-0">
          <div id="sidebarName" class="font-semibold truncate">---</div>
          <div id="sidebarEmail" class="text-xs text-gray-500 truncate">---</div>
        </div>

      </div>

      <!-- MENU -->
      <nav class="space-y-2">
        <button id="navLookup"
          class="w-full text-left px-3 py-2 rounded-md bg-green-50 text-green-700 flex items-center gap-3">
          üîç Tra c·ª©u CIC
        </button>

        <button id="navHistory"
          class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üìú L·ªãch s·ª≠ tra c·ª©u
        </button>

        <!-- ADMIN BUTTON ·∫©n cho nh√¢n vi√™n -->
        <button id="navAdmin"
          class="hidden w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üõ°Ô∏è Trang Admin
        </button>
      </nav>

      <div class="mt-4 border-t pt-3">
        <button id="btnEditName"
          class="w-full text-left text-sm mb-2 px-2 py-2 rounded-md hover:bg-gray-100">
          ‚úèÔ∏è C·∫≠p nh·∫≠t h·ªç t√™n
        </button>

        <button id="btnLogout"
          class="w-full text-left text-sm text-red-600 px-2 py-2 rounded-md hover:bg-red-50">
          üö™ ƒêƒÉng xu·∫•t
        </button>
      </div>
    </aside>
    <!-- MAIN CONTENT -->
    <main class="flex-1">

      <!-- AUTH BOX (LOGIN + SIGNUP) -->
      <section id="authBox" class="mx-auto card rounded-lg shadow p-4 md:p-6 max-w-lg">
        <div id="authForms">

          <!-- SIGNUP FORM -->
          <div id="signupArea">
            <h3 class="text-lg md:text-xl font-semibold mb-3">ƒêƒÉng k√Ω t√†i kho·∫£n</h3>

            <form id="signupForm" class="space-y-2">
              <input id="signupName" class="w-full border rounded-md px-3 py-2"
                     placeholder="H·ªç t√™n nh√¢n vi√™n" required />

              <input id="signupEmail" type="email"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="Email" required />

              <input id="signupPass" type="password"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="M·∫≠t kh·∫©u" required />

              <input id="signupRepass" type="password"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit"
                        class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md">
                  ƒêƒÉng k√Ω
                </button>

                <button id="showLoginBtn"
                        class="flex-1 border rounded-md px-4 py-2">
                  ƒê√£ c√≥ t√†i kho·∫£n
                </button>
              </div>
            </form>
          </div>

          <!-- LOGIN FORM -->
          <div id="loginArea" class="hidden">
            <h3 class="text-lg md:text-xl font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>

            <form id="loginForm" class="space-y-2">
              <input id="loginEmail" type="email"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="Email" required />

              <input id="loginPass" type="password"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="M·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit"
                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md">
                  ƒêƒÉng nh·∫≠p
                </button>

                <button id="showSignupBtn"
                        class="flex-1 border rounded-md px-4 py-2">
                  ƒêƒÉng k√Ω
                </button>
              </div>
            </form>
          </div>

        </div>
      </section>
      <!-- APP AREA (SAU KHI ƒêƒÇNG NH·∫¨P) -->
      <section id="appArea" class="hidden space-y-6">

        <!-- LOOKUP PAGE ‚Äì NH√ÇN VI√äN G·ª¨I TRA C·ª®U -->
        <div id="lookupPage" class="card rounded-lg p-4 md:p-6">

          <div class="mb-4 text-red-600 font-bold text-xs">
            üì¢ Th√¥ng b√°o tra c·ª©u B11<br>
            ‚Ä¢ X·ª≠ l√Ω trong gi·ªù h√†nh ch√≠nh: 30 ph√∫t ‚Äì 1 ti·∫øng<br>
            ‚Ä¢ Nh·∫≠p ƒë√∫ng h·ªç t√™n KH, CCCD ƒë·ªß 12 s·ªë<br>
            ‚Ä¢ K·∫øt qu·∫£ xem t·∫°i m·ª•c ‚ÄúL·ªãch s·ª≠ tra c·ª©u‚Äù
          </div>

          <h3 class="text-lg font-semibold mb-4">üîé G·ª≠i y√™u c·∫ßu tra c·ª©u B11</h3>

          <form id="lookupForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">

            <div class="md:col-span-7">
              <label class="text-sm text-gray-600">H·ªç v√† t√™n kh√°ch h√†ng</label>
              <input id="fullname"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="Nguy·ªÖn VƒÉn A" required />
            </div>

            <div class="md:col-span-5">
              <label class="text-sm text-gray-600">S·ªë CCCD (12 s·ªë)</label>
              <input id="cccd" maxlength="12"
                     class="w-full border rounded-md px-3 py-2"
                     placeholder="123456789012" required />
            </div>

            <div class="md:col-span-12">
              <button type="submit"
                      class="bg-green-600 text-white px-5 py-2 rounded-md w-full md:w-auto">
                G·ª≠i tra c·ª©u
              </button>
            </div>

          </form>

          <div id="lookupResult" class="mt-4 text-sm text-gray-700">
            Ch∆∞a c√≥ k·∫øt qu·∫£.
          </div>

        </div> <!-- END LOOKUP PAGE -->


        <!-- HISTORY PAGE ‚Äî NH√ÇN VI√äN NH·∫¨N K·∫æT QU·∫¢ -->
        <div id="historyPage" class="card rounded-lg p-4 md:p-6 hidden">

          <h3 class="text-lg font-semibold mb-4">üìú L·ªãch s·ª≠ tra c·ª©u c·ªßa b·∫°n</h3>

          <div id="historyList" class="space-y-2 text-sm text-gray-700">
            Ch∆∞a c√≥ l·ªãch s·ª≠.
          </div>

        </div> <!-- END HISTORY PAGE -->


        <!-- ADMIN PAGE ‚Äì ADMIN TR·∫¢ K·∫æT QU·∫¢ -->
        <div id="adminPage" class="card rounded-lg p-4 md:p-6 hidden">

          <h3 class="text-xl font-semibold mb-4">üõ°Ô∏è TRANG ADMIN ‚Äì TR·∫¢ K·∫æT QU·∫¢ CIC</h3>

          <div id="adminList" class="space-y-6 text-sm text-gray-700">
            ƒêang t·∫£i d·ªØ li·ªáu...
          </div>

        </div> <!-- END ADMIN PAGE -->

      </section> <!-- END APP AREA -->

    </main>
  </div> <!-- END MAIN LAYOUT -->
  <!-- MODAL: C·∫¨P NH·∫¨T T√äN NH√ÇN VI√äN -->
  <div id="updateNameBox"
       class="fixed right-4 bottom-4 md:right-6 md:bottom-6 hidden z-50">
    <div class="bg-white p-3 rounded-lg shadow w-64">

      <div class="mb-2 text-sm font-medium">C·∫≠p nh·∫≠t h·ªç t√™n</div>

      <input id="updateNameInput"
             class="w-full border rounded-md px-3 py-2 mb-2"
             placeholder="H·ªç v√† t√™n m·ªõi" />

      <div class="flex gap-2">
        <button id="saveNameBtn"
                class="bg-green-600 text-white px-3 py-1 rounded-md">
          L∆∞u
        </button>

        <button id="cancelNameBtn"
                class="border px-3 py-1 rounded-md">
          H·ªßy
        </button>
      </div>

    </div>
  </div>


  <!-- FOOTER -->
  <footer class="mt-6 md:mt-8">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-4 text-center text-sm text-gray-500 border-t bg-white">
      ¬© Copyright 2025 VQT ‚Äî Gi·∫£i ph√°p vay ti√™u d√πng uy t√≠n & linh ho·∫°t
    </div>
  </footer>


  <!-- B·∫ÆT ƒê·∫¶U FIREBASE SCRIPT -->
  <script type="module">

    /* =============================
          IMPORT FIREBASE SDK
    ============================== */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updateProfile,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      onSnapshot,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


    /* =============================
            FIREBASE CONFIG
    ============================== */

    const firebaseConfig = {
      apiKey: "AIzaSyDyksVWuBPVVbHix7u-OZmIh8nFu66uNFo",
      authDomain: "tracuucic-login.firebaseapp.com",
      projectId: "tracuucic-login",
      storageBucket: "tracuucic-login.firebasestorage.app",
      messagingSenderId: "648747772689",
      appId: "1:648747772689:web:69da6e1534ed63efddbab0",
      measurementId: "G-ELVGHX2GL4"
    };

    /* =============================
          INIT FIREBASE APP
    ============================== */

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* =============================
              DOM ELEMENTS
    ============================== */

    const authBox      = document.getElementById("authBox");
    const signupArea   = document.getElementById("signupArea");
    const loginArea    = document.getElementById("loginArea");

    const sidebarName  = document.getElementById("sidebarName");
    const sidebarEmail = document.getElementById("sidebarEmail");
    const sidebarAvatar = document.getElementById("sidebarAvatar");

    const navLookup  = document.getElementById("navLookup");
    const navHistory = document.getElementById("navHistory");
    const navAdmin   = document.getElementById("navAdmin");

    const appArea     = document.getElementById("appArea");
    const lookupPage  = document.getElementById("lookupPage");
    const historyPage = document.getElementById("historyPage");
    const adminPage   = document.getElementById("adminPage");

    const notifBell  = document.getElementById("notifBell");
    const notifCount = document.getElementById("notifCount");

    const lookupForm   = document.getElementById("lookupForm");
    const lookupResult = document.getElementById("lookupResult");

    const historyList = document.getElementById("historyList");
    const adminList   = document.getElementById("adminList");

    const updateNameBox   = document.getElementById("updateNameBox");
    const updateNameInput = document.getElementById("updateNameInput");
    const saveNameBtn     = document.getElementById("saveNameBtn");
    const cancelNameBtn   = document.getElementById("cancelNameBtn");


    /* =============================
          ADMIN EMAIL (C·ªê ƒê·ªäNH)
    ============================== */
    const ADMIN_EMAIL = "vothienbdn@gmail.com";

    function isAdmin(user) {
      return user && user.email === ADMIN_EMAIL;
    }


    /* =============================
        SWITCH SIGNUP <-> LOGIN
    ============================== */

    document.getElementById("showLoginBtn").addEventListener("click", (e) => {
      e.preventDefault();
      signupArea.classList.add("hidden");
      loginArea.classList.remove("hidden");
    });

    document.getElementById("showSignupBtn").addEventListener("click", (e) => {
      e.preventDefault();
      loginArea.classList.add("hidden");
      signupArea.classList.remove("hidden");
    });


    /* =============================
                SIGNUP
    ============================== */

    const signupForm = document.getElementById("signupForm");

    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name   = document.getElementById("signupName").value.trim();
      const email  = document.getElementById("signupEmail").value.trim();
      const pass   = document.getElementById("signupPass").value;
      const repass = document.getElementById("signupRepass").value;

      if (!name || !email || !pass) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      if (pass !== repass) {
        alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!");
        return;
      }

      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);

        await updateProfile(userCred.user, { displayName: name });

        alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
        signupForm.reset();

        signupArea.classList.add("hidden");
        loginArea.classList.remove("hidden");

      } catch (err) {
        alert("L·ªói ƒëƒÉng k√Ω: " + err.message);
      }
    });
    /* =============================
                LOGIN
    ============================== */

    const loginForm = document.getElementById("loginForm");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("loginEmail").value.trim();
      const pass  = document.getElementById("loginPass").value;

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        loginForm.reset();

      } catch (err) {
        alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
      }
    });


    /* =============================
                LOGOUT
    ============================== */

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
      alert("ƒê√£ ƒëƒÉng xu·∫•t!");
      location.reload();
    });


    /* =============================
             UPDATE DISPLAY NAME
    ============================== */

    document.getElementById("btnEditName").addEventListener("click", () => {
      updateNameInput.value =
        sidebarName.textContent === "---" ? "" : sidebarName.textContent;

      updateNameBox.classList.remove("hidden");
    });

    cancelNameBtn.addEventListener("click", () => {
      updateNameBox.classList.add("hidden");
    });

    saveNameBtn.addEventListener("click", async () => {
      const newName = updateNameInput.value.trim();

      if (!newName) return alert("Vui l√≤ng nh·∫≠p h·ªç t√™n m·ªõi!");

      try {
        await updateProfile(auth.currentUser, { displayName: newName });

        sidebarName.textContent = newName;
        sidebarAvatar.textContent = newName.trim().charAt(0).toUpperCase();

        updateNameBox.classList.add("hidden");
        alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");

      } catch (err) {
        alert("L·ªói c·∫≠p nh·∫≠t t√™n: " + err.message);
      }
    });


    /* =============================
           PAGE NAVIGATION (MENU)
    ============================== */

    function showLookupPage() {
      lookupPage.classList.remove("hidden");
      historyPage.classList.add("hidden");
      adminPage.classList.add("hidden");
    }

    function showHistoryPage() {
      lookupPage.classList.add("hidden");
      historyPage.classList.remove("hidden");
      adminPage.classList.add("hidden");
    }

    function showAdminPage() {
      lookupPage.classList.add("hidden");
      historyPage.classList.add("hidden");
      adminPage.classList.remove("hidden");
    }

    navLookup.addEventListener("click", showLookupPage);
    navHistory.addEventListener("click", showHistoryPage);
    navAdmin.addEventListener("click", showAdminPage);
    /* ==========================================================
                EMPLOYEE ‚Äî G·ª¨I Y√äU C·∫¶U TRA C·ª®U
    ========================================================== */

    lookupForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user) {
        alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
        return;
      }

      const customerName = document.getElementById("fullname").value.trim();
      const cccdValue    = document.getElementById("cccd").value.trim();

      if (!customerName || cccdValue.length !== 12) {
        alert("Vui l√≤ng nh·∫≠p ƒë√∫ng h·ªç t√™n v√† CCCD 12 s·ªë");
        return;
      }

      lookupResult.innerHTML = "‚è≥ ƒêang g·ª≠i y√™u c·∫ßu...";

      try {
        await addDoc(collection(db, "tra_cuu_b11"), {
          uid: user.uid,

          employeeName: user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)",
          employeeEmail: user.email,

          customerName,
          cccd: cccdValue,

          ketQua: {},   // admin update sau
          createdAt: serverTimestamp()
        });

        lookupResult.innerHTML =
          `<span class="text-green-600 font-semibold">ƒê√£ g·ª≠i th√†nh c√¥ng!</span>`;

        lookupForm.reset();

      } catch (err) {
        lookupResult.innerHTML =
          `<span class="text-red-600">L·ªói g·ª≠i d·ªØ li·ªáu: ${err.message}</span>`;
      }
    });


    /* ==========================================================
                EMPLOYEE ‚Äî REALTIME L·ªäCH S·ª¨ TRA C·ª®U
    ========================================================== */

    let unsubHistory = null;
    let seenResultIDs = new Set();
    let newNotifCount = 0;

    function startHistoryListener() {
      const user = auth.currentUser;
      if (!user) return;

      if (unsubHistory) unsubHistory();

      const q = query(
        collection(db, "tra_cuu_b11"),
        orderBy("createdAt", "desc"),
        limit(100)
      );

      unsubHistory = onSnapshot(q, (snapshot) => {

        const items = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.uid === user.uid) items.push({ id: docSnap.id, ...data });
        });

        if (!items.length) {
          historyList.innerHTML = "<div>Ch∆∞a c√≥ l·ªãch s·ª≠ tra c·ª©u.</div>";
          return;
        }

        historyList.innerHTML = "";

        items.forEach(item => {
          const timeStr = item.createdAt?.toDate?.().toLocaleString() || "";

          const hasResult = item.ketQua && Object.keys(item.ketQua).length > 0;

          // üîî Notification khi admin tr·∫£ k·∫øt qu·∫£
          if (hasResult && !seenResultIDs.has(item.id)) {
            seenResultIDs.add(item.id);
            newNotifCount++;
            notifCount.textContent = newNotifCount;
          }

          const div = document.createElement("div");
          div.className = "p-3 border rounded-md";

          div.innerHTML = `
            <div class="font-medium">${item.customerName}</div>

            <div class="text-xs text-gray-500">
              CCCD: ${item.cccd} ‚Äî ${timeStr}
            </div>

            <div class="text-sm mt-1">
              ${hasResult
                ? `
                  <div class="text-green-700 font-semibold">K·∫æT QU·∫¢:</div>
                  <div>‚Ä¢ Quan h·ªá TCTD: ${item.ketQua.tctd || ""}</div>
                  <div>‚Ä¢ N·ª£ x·∫•u: ${item.ketQua.noXau || ""}</div>
                  <div>‚Ä¢ N·ª£ ch√∫ √Ω: ${item.ketQua.noChuY || ""}</div>
                  <div>‚Ä¢ T·ªïng d∆∞ n·ª£: ${item.ketQua.tongDuNo || ""}</div>
                  <div>‚Ä¢ Ghi ch√∫: ${item.ketQua.ghiChu || ""}</div>
                `
                : `<span class="text-blue-600 font-semibold">Ch∆∞a c√≥ k·∫øt qu·∫£</span>`
              }
            </div>

            <div class="text-xs text-gray-400 mt-1">
              Nh√¢n vi√™n: ${item.employeeName} ‚Ä¢ ${item.employeeEmail}
            </div>
          `;

          historyList.appendChild(div);
        });
      });
    }


    /* ==========================================================
                     üîî CLICK CHU√îNG ‚Üí M·ªû L·ªäCH S·ª¨
    ========================================================== */

    notifBell.addEventListener("click", () => {
      newNotifCount = 0;
      notifCount.textContent = "0";

      showHistoryPage();
      startHistoryListener();
    });


    /* ==========================================================
                   ADMIN ‚Äî LOAD REAlTIME T·∫§T C·∫¢ Y√äU C·∫¶U
    ========================================================== */

    let unsubAdmin = null;

    function startAdminListener() {
      const user = auth.currentUser;
      if (!isAdmin(user)) return;

      if (unsubAdmin) unsubAdmin();

      const q = query(
        collection(db, "tra_cuu_b11"),
        orderBy("createdAt", "desc"),
        limit(200)
      );

      unsubAdmin = onSnapshot(q, (snapshot) => {

        adminList.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const item = docSnap.data();
          const docId = docSnap.id;

          const timeStr = item.createdAt?.toDate?.().toLocaleString() || "";
          const k = item.ketQua || {};

          const block = document.createElement("div");
          block.className = "border rounded-lg p-4";

          block.innerHTML = `
            <div class="font-bold text-lg mb-2">${item.customerName}</div>

            <div class="text-sm text-gray-600 mb-2">
              CCCD: ${item.cccd} ‚Ä¢ G·ª≠i l√∫c: ${timeStr}
            </div>

            <div class="text-sm text-gray-500 mb-2">
              Nh√¢n vi√™n: ${item.employeeName} ‚Ä¢ ${item.employeeEmail}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">

              <div>
                <label class="text-sm font-semibold">Quan h·ªá t·∫°i TCTD</label>
                <input data-id="${docId}" data-field="tctd"
                       class="admin-input w-full border rounded-md px-3 py-2"
                       value="${k.tctd || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">N·ª£ x·∫•u</label>
                <input data-id="${docId}" data-field="noXau"
                       class="admin-input w-full border rounded-md px-3 py-2"
                       value="${k.noXau || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">N·ª£ ch√∫ √Ω</label>
                <input data-id="${docId}" data-field="noChuY"
                       class="admin-input w-full border rounded-md px-3 py-2"
                       value="${k.noChuY || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">T·ªïng d∆∞ n·ª£</label>
                <input data-id="${docId}" data-field="tongDuNo"
                       class="admin-input w-full border rounded-md px-3 py-2"
                       value="${k.tongDuNo || ""}">
              </div>

              <div class="md:col-span-2">
                <label class="text-sm font-semibold">Ghi ch√∫</label>
                <textarea data-id="${docId}" data-field="ghiChu"
                          class="admin-input w-full border rounded-md px-3 py-2"
                >${k.ghiChu || ""}</textarea>
              </div>

            </div>

            <button class="saveKetQua mt-4 bg-green-600 text-white px-4 py-2 rounded-md"
                    data-save="${docId}">
              üíæ L∆∞u k·∫øt qu·∫£
            </button>
          `;

          adminList.appendChild(block);
        });

        attachAdminSaveEvents();
      });
    }


    /* ==========================================================
              ADMIN ‚Äî L∆ØU K·∫æT QU·∫¢ TR·∫¢ CIC V√ÄO FIRESTORE
    ========================================================== */

    function attachAdminSaveEvents() {
      document.querySelectorAll(".saveKetQua").forEach((btn) => {
        btn.addEventListener("click", async () => {

          const docId = btn.getAttribute("data-save");

          const inputs = document.querySelectorAll(
            `.admin-input[data-id="${docId}"]`
          );

          const ketQua = {};
          inputs.forEach((input) => {
            ketQua[input.getAttribute("data-field")] = input.value.trim();
          });

          try {
            await updateDoc(doc(db, "tra_cuu_b11", docId), { ketQua });
            alert("ƒê√£ l∆∞u k·∫øt qu·∫£!");

          } catch (err) {
            alert("L·ªói l∆∞u k·∫øt qu·∫£: " + err.message);
          }

        });
      });
    }
    /* ==========================================================
                AUTH STATE ‚Äî CH·∫†Y KHI ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T
    ========================================================== */

    onAuthStateChanged(auth, (user) => {

      if (user) {
        // ·∫®n form login/signup
        authBox.classList.add("hidden");

        // Hi·ªán giao di·ªán ch√≠nh
        appArea.classList.remove("hidden");

        // Fill sidebar info
        const name = user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)";
        sidebarName.textContent = name;
        sidebarEmail.textContent = user.email;
        sidebarAvatar.textContent = name.trim().charAt(0).toUpperCase();

        // N·∫øu l√† admin ‚Üí m·ªü n√∫t Admin Page
        if (isAdmin(user)) {
          navAdmin.classList.remove("hidden");
          startAdminListener();  // B·∫Øt ƒë·∫ßu realtime admin
        } else {
          navAdmin.classList.add("hidden");
        }

        // Reset notification state
        seenResultIDs.clear();
        newNotifCount = 0;
        notifCount.textContent = "0";

        // Load history listener
        startHistoryListener();

      } else {
        // ƒêƒÉng xu·∫•t ‚Üí Reset UI
        authBox.classList.remove("hidden");
        appArea.classList.add("hidden");

        sidebarName.textContent = "---";
        sidebarEmail.textContent = "---";
        sidebarAvatar.textContent = "?";

        notifCount.textContent = "0";

        if (unsubHistory) unsubHistory();
        if (unsubAdmin) unsubAdmin();
      }
    });

  </script>

</body>
</html>
