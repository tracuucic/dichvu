<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang T·ªïng H·ª£p - Tra C·ª©u B11</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .avatar-green {
      background: linear-gradient(135deg, #16a34a, #34d399);
    }

    .card {
      background: #ffffff;
    }

    .notif-bell {
      position: relative;
      cursor: pointer;
      display: inline-block;
      font-size: 24px;
    }

    .notif-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 18px;
      height: 18px;
      text-align: center;
      border-radius: 50%;
      line-height: 18px;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <!-- HEADER -->
  <header class="bg-white border-b shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 avatar-green text-white font-bold rounded-md flex justify-center items-center">MAFC</div>
        <div>
          <div class="font-semibold text-lg">TRANG T·ªîNG H·ª¢P</div>
          <div class="text-xs text-gray-500">Gi·∫£i ph√°p B11 - Hotline: 0964307247</div>
        </div>
      </div>

      <div id="headerRight" class="text-sm text-gray-700">
        <span id="notifBell" class="notif-bell">üîî<span id="notifCount" class="notif-count">0</span></span>
      </div>
    </div>
  </header>


  <!-- MAIN LAYOUT -->
  <div class="max-w-6xl mx-auto px-4 py-6 flex gap-6">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border rounded-lg shadow p-4 flex-shrink-0">
      <div class="flex items-center gap-3 mb-6">
        <div id="sidebarAvatar"
          class="w-10 h-10 avatar-green text-white font-bold rounded-md flex justify-center items-center">?</div>

        <div>
          <div id="sidebarName" class="font-semibold">---</div>
          <div id="sidebarEmail" class="text-xs text-gray-500">---</div>
        </div>
      </div>

      <nav class="space-y-2">
        <button id="navLookup"
          class="w-full text-left px-3 py-2 rounded-md bg-green-50 text-green-700">üîç Tra c·ª©u CIC</button>

        <button id="navHistory"
          class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100">üìú L·ªãch s·ª≠ tra c·ª©u</button>

        <button id="navAdmin"
          class="hidden w-full text-left px-3 py-2 rounded-md hover:bg-gray-100">üõ°Ô∏è Trang Admin</button>

        <button id="navTinhLai"
          class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100">üí∞ T√≠nh L√£i Su·∫•t</button>
      </nav>

      <div class="mt-6 border-t pt-4">
        <button id="btnEditName"
          class="w-full text-left text-sm px-3 py-2 rounded-md hover:bg-gray-100">‚úèÔ∏è C·∫≠p nh·∫≠t h·ªç t√™n</button>

        <button id="btnLogout"
          class="w-full text-left text-sm px-3 py-2 rounded-md text-red-600 hover:bg-red-50">üö™ ƒêƒÉng xu·∫•t</button>
      </div>
    </aside>
<!-- MAIN CONTENT -->
<main class="flex-1">

  <!-- LOGIN & SIGNUP BOX -->
  <section id="authBox" class="mx-auto card rounded-lg shadow p-6 max-w-lg">
    <div id="authForms">

      <!-- SIGNUP -->
      <div id="signupArea">
        <h3 class="text-lg font-semibold mb-3">ƒêƒÉng k√Ω t√†i kho·∫£n</h3>

        <form id="signupForm" class="space-y-3">
          <input id="signupName" class="w-full border rounded-md px-3 py-2" placeholder="H·ªç t√™n nh√¢n vi√™n" required />

          <input id="signupEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email"
            required />

          <input id="signupPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="M·∫≠t kh·∫©u"
            required />

          <input id="signupRepass" type="password" class="w-full border rounded-md px-3 py-2"
            placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required />

          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-md">ƒêƒÉng k√Ω</button>
            <button id="showLoginBtn" class="flex-1 border rounded-md">ƒê√£ c√≥ t√†i kho·∫£n</button>
          </div>
        </form>
      </div>

      <!-- LOGIN -->
      <div id="loginArea" class="hidden">
        <h3 class="text-lg font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>

        <form id="loginForm" class="space-y-3">
          <input id="loginEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email"
            required />

          <input id="loginPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="M·∫≠t kh·∫©u"
            required />

          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-md">ƒêƒÉng nh·∫≠p</button>
            <button id="showSignupBtn" class="flex-1 border rounded-md">ƒêƒÉng k√Ω</button>
          </div>
        </form>
      </div>

    </div>
  </section>

  <!-- APP CONTENT -->
  <section id="appArea" class="hidden space-y-6">


    <!-- TRA C·ª®U PAGE -->
    <div id="lookupPage" class="card rounded-lg p-6">
      <div class="mb-4 text-red-600 font-bold text-xs">
        üì¢ L∆∞u √Ω tra c·ª©u B11:<br>
        ‚Ä¢ Th·ªùi gian tr·∫£ k·∫øt qu·∫£: 30 ph√∫t ‚Äì 1 ti·∫øng<br>
        ‚Ä¢ Ghi ch√≠nh x√°c h·ªç t√™n kh√°ch h√†ng<br>
        ‚Ä¢ K·∫øt qu·∫£ hi·ªÉn th·ªã t·∫°i m·ª•c ‚ÄúL·ªãch s·ª≠ tra c·ª©u‚Äù
      </div>

      <h3 class="text-lg font-semibold mb-4">üîé Tra c·ª©u B11</h3>

      <form id="lookupForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div class="md:col-span-7">
          <label class="text-sm text-gray-600">H·ªç v√† t√™n kh√°ch h√†ng</label>
          <input id="fullname" class="w-full border rounded-md px-3 py-2" placeholder="Nguy·ªÖn VƒÉn A" required />
        </div>

        <div class="md:col-span-5">
          <label class="text-sm text-gray-600">S·ªë CCCD (12 s·ªë)</label>
          <input id="cccd" maxlength="12" class="w-full border rounded-md px-3 py-2" placeholder="123456789012"
            required />
        </div>

        <div class="md:col-span-12">
          <button type="submit"
            class="bg-green-600 text-white px-6 py-2 rounded-md w-full md:w-auto">G·ª≠i tra c·ª©u</button>
        </div>
      </form>

      <div id="lookupResult" class="mt-4 text-sm text-gray-700">Ch∆∞a c√≥ k·∫øt qu·∫£.</div>
    </div>


    <!-- L·ªäCH S·ª¨ PAGE (NH√ÇN VI√äN) -->
    <div id="historyPage" class="card rounded-lg p-6 hidden">
      <h3 class="text-lg font-semibold mb-4">üìú L·ªãch s·ª≠ tra c·ª©u c·ªßa b·∫°n</h3>

      <div id="historyList" class="space-y-2 text-sm text-gray-700">
        Ch∆∞a c√≥ l·ªãch s·ª≠.
      </div>
    </div>


    <!-- ADMIN PAGE -->
    <div id="adminPage" class="card rounded-lg p-6 hidden">
      <h3 class="text-xl font-semibold mb-4">üõ°Ô∏è TRANG QU·∫¢N TR·ªä - TR·∫¢ K·∫æT QU·∫¢ B11</h3>

      <div id="adminList" class="space-y-6 text-sm text-gray-700">
        ƒêang t·∫£i d·ªØ li·ªáu...
      </div>
    </div>


    <!-- T√çNH L√ÉI PAGE -->
    <div id="tinhLaiPage" class="card rounded-lg p-0 hidden" style="height: calc(100vh - 120px);">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-lg font-semibold">üí∞ C√¥ng c·ª• t√≠nh l√£i su·∫•t</h3>
        <button id="btnBackFromTinhLai" class="px-3 py-1 rounded-md border">‚¨Ö Quay l·∫°i</button>
      </div>

      <iframe src="https://miraeasset-mt.github.io/vaytieudung/"
        class="w-full h-full border-0 rounded-md"></iframe>
    </div>


  </section>

</main>
<script type="module">
/* ============================
   IMPORT FIREBASE MODULES
============================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateProfile,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  limit,
  onSnapshot,
  doc,
  updateDoc,
  getDoc,
  where
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


/* ============================
   FIREBASE CONFIG
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyDyksVWuBPVVbHix7u-OZmIh8nFu66uNFo",
  authDomain: "tracuucic-login.firebaseapp.com",
  projectId: "tracuucic-login",
  storageBucket: "tracuucic-login.firebasestorage.app",
  messagingSenderId: "648747772689",
  appId: "1:648747772689:web:69da6e1534ed63efddbab0",
  measurementId: "G-ELVGHX2GL4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


/* ============================
   DOM ELEMENTS
============================= */
const authBox = document.getElementById("authBox");
const appArea = document.getElementById("appArea");

const signupArea = document.getElementById("signupArea");
const loginArea = document.getElementById("loginArea");

const sidebarName = document.getElementById("sidebarName");
const sidebarEmail = document.getElementById("sidebarEmail");

const navLookup = document.getElementById("navLookup");
const navHistory = document.getElementById("navHistory");
const navAdmin = document.getElementById("navAdmin");
const navTinhLai = document.getElementById("navTinhLai");

const lookupPage = document.getElementById("lookupPage");
const historyPage = document.getElementById("historyPage");
const adminPage = document.getElementById("adminPage");
const tinhLaiPage = document.getElementById("tinhLaiPage");

const notifBell = document.getElementById("notifBell");
const notifCount = document.getElementById("notifCount");

let newNotifCount = 0;
let seenResultIDs = new Set();



/* ============================
   CHECK ADMIN
============================= */
function isAdmin(user) {
  if (!user) return false;

  return user.email === "thien.miraeasset@gmail.com";
}


/* ============================
   ON AUTH STATE CHANGED
============================= */
onAuthStateChanged(auth, (user) => {
  if (user) {
    authBox.classList.add("hidden");
    appArea.classList.remove("hidden");

    sidebarName.textContent = user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)";
    sidebarEmail.textContent = user.email;

    if (isAdmin(user)) {
      navAdmin.classList.remove("hidden");
      startAdminListener();
    } else {
      navAdmin.classList.add("hidden");
      startEmployeeHistoryListener();
    }

  } else {
    appArea.classList.add("hidden");
    authBox.classList.remove("hidden");
  }
});


/* ============================
   SIGNUP
============================= */
document.getElementById("signupForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = signupName.value.trim();
  const email = signupEmail.value.trim();
  const pass = signupPass.value;
  const repass = signupRepass.value;

  if (pass !== repass) return alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!");

  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(userCred.user, { displayName: name });

    alert("ƒêƒÉng k√Ω th√†nh c√¥ng, vui l√≤ng ƒëƒÉng nh·∫≠p!");
    signupForm.reset();
    signupArea.classList.add("hidden");
    loginArea.classList.remove("hidden");

  } catch (err) {
    alert("L·ªói ƒëƒÉng k√Ω: " + err.message);
  }
});


/* ============================
   LOGIN
============================= */
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  try {
    await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPass.value);
  } catch (err) {
    alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
  }
});


/* ============================
   LOGOUT
============================= */
document.getElementById("btnLogout").onclick = () => signOut(auth);


/* ============================
   NAVIGATION
============================= */
navLookup.onclick = () => {
  lookupPage.classList.remove("hidden");
  historyPage.classList.add("hidden");
  adminPage.classList.add("hidden");
  tinhLaiPage.classList.add("hidden");
};

navHistory.onclick = () => {
  lookupPage.classList.add("hidden");
  historyPage.classList.remove("hidden");
  adminPage.classList.add("hidden");
  tinhLaiPage.classList.add("hidden");

  startEmployeeHistoryListener();
};

navAdmin.onclick = () => {
  lookupPage.classList.add("hidden");
  historyPage.classList.add("hidden");
  adminPage.classList.remove("hidden");
  tinhLaiPage.classList.add("hidden");

  startAdminListener();
};

navTinhLai.onclick = () => {
  lookupPage.classList.add("hidden");
  historyPage.classList.add("hidden");
  adminPage.classList.add("hidden");
  tinhLaiPage.classList.remove("hidden");
};



/* ==========================================
   EMPLOYEE HISTORY LISTENER (ONLY EMPLOYEE)
============================================= */
function startEmployeeHistoryListener() {
  const user = auth.currentUser;
  if (!user) return;

  const q = query(
    collection(db, "tra_cuu_b11"),
    where("uid", "==", user.uid),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snapshot) => {
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    if (snapshot.empty) {
      list.innerHTML = `<div>Ch∆∞a c√≥ l·ªãch s·ª≠ tra c·ª©u.</div>`;
      return;
    }

    snapshot.forEach((docu) => {
      const d = docu.data();
      const t = d.createdAt?.toDate?.().toLocaleString() || "";

      let ketqua = `
        <div class="ml-2 text-sm text-gray-700">
          ‚Ä¢ TCTD: ${d.ketQua?.tctd || "‚Äî"}<br>
          ‚Ä¢ N·ª£ x·∫•u: ${d.ketQua?.noXau || "‚Äî"}<br>
          ‚Ä¢ N·ª£ ch√∫ √Ω: ${d.ketQua?.noChuY || "‚Äî"}<br>
          ‚Ä¢ T·ªïng d∆∞ n·ª£: ${d.ketQua?.tongDuNo || "‚Äî"}<br>
          ‚Ä¢ Ghi ch√∫: ${d.ketQua?.ghiChu || "‚Äî"}
        </div>
      `;

      const item = `
        <div class="p-3 border rounded-md">
          <div class="font-semibold">${d.customerName}</div>
          <div class="text-xs text-gray-500">CCCD: ${d.cccd} ‚Ä¢ ${t}</div>

          <div class="mt-1 font-medium text-blue-700">K·∫øt qu·∫£:</div>
          ${ketqua}
        </div>
      `;

      list.innerHTML += item;
    });
  });
}



/* ==========================================================
   ADMIN LISTENER (VIEW ALL REQUESTS)
============================================================= */
function startAdminListener() {
  const q = query(
    collection(db, "tra_cuu_b11"),
    orderBy("createdAt", "desc"),
    limit(200)
  );

  onSnapshot(q, (snapshot) => {
    const adminList = document.getElementById("adminList");
    adminList.innerHTML = "";

    snapshot.forEach((docu) => {
      const d = docu.data();
      const id = docu.id;
      const t = d.createdAt?.toDate?.().toLocaleString() || "";

      let block = `
        <div class="p-4 border rounded-lg bg-gray-50">

          <div class="font-semibold text-lg">${d.customerName}</div>
          <div class="text-xs text-gray-500">CCCD: ${d.cccd} ‚Ä¢ ${t}</div>
          <div class="text-xs text-gray-400 mb-3">
            Nh√¢n vi√™n: ${d.employeeName} ‚Ä¢ ${d.employeeEmail}
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

            <div>
              <label class="text-xs">Hi·ªán ƒëang quan h·ªá t·∫°i TCTD</label>
              <input id="tctd_${id}" class="border rounded-md px-2 py-1 w-full" value="${d.ketQua?.tctd || ""}">
            </div>

            <div>
              <label class="text-xs">N·ª£ x·∫•u</label>
              <input id="noxau_${id}" class="border rounded-md px-2 py-1 w-full" value="${d.ketQua?.noXau || ""}">
            </div>

            <div>
              <label class="text-xs">N·ª£ ch√∫ √Ω</label>
              <input id="nochuy_${id}" class="border rounded-md px-2 py-1 w-full" value="${d.ketQua?.noChuY || ""}">
            </div>

            <div>
              <label class="text-xs">T·ªïng d∆∞ n·ª£</label>
              <input id="tongduno_${id}" class="border rounded-md px-2 py-1 w-full" value="${d.ketQua?.tongDuNo || ""}">
            </div>

          </div>

          <div class="mt-3">
            <label class="text-xs">Ghi ch√∫</label>
            <textarea id="ghichu_${id}" class="border rounded-md w-full px-2 py-1" rows="2">${d.ketQua?.ghiChu || ""}</textarea>
          </div>

          <button onclick="saveKetQua('${id}')"
            class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md">üíæ L∆∞u k·∫øt qu·∫£</button>

        </div>
      `;

      adminList.innerHTML += block;
    });
  });
}



/* ==========================================================
   ADMIN SAVE RESULT
============================================================= */
window.saveKetQua = async function (id) {
  let tctd = document.getElementById(`tctd_${id}`).value.trim();
  let noXau = document.getElementById(`noxau_${id}`).value.trim();
  let noChuY = document.getElementById(`nochuy_${id}`).value.trim();
  let tongDuNo = document.getElementById(`tongduno_${id}`).value.trim();
  let ghiChu = document.getElementById(`ghichu_${id}`).value.trim();

  try {
    await updateDoc(doc(db, "tra_cuu_b11", id), {
      ketQua: { tctd, noXau, noChuY, tongDuNo, ghiChu }
    });

    alert("ƒê√£ l∆∞u k·∫øt qu·∫£!");
  } catch (err) {
    alert("L·ªói l∆∞u d·ªØ li·ªáu: " + err.message);
  }
};



/* ==========================================================
   SUBMIT LOOKUP REQUEST
============================================================= */
document.getElementById("lookupForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");

  const customerName = fullname.value.trim();
  const cccd = cccd.value.trim();

  if (cccd.length !== 12) return alert("CCCD ph·∫£i ƒë·ªß 12 s·ªë");

  try {
    await addDoc(collection(db, "tra_cuu_b11"), {
      uid: user.uid,
      customerName,
      cccd,
      employeeName: user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)",
      employeeEmail: user.email,
      ketQua: {},
      createdAt: serverTimestamp()
    });

    lookupResult.innerHTML = `<span class="text-green-600">ƒê√£ g·ª≠i tra c·ª©u!</span>`;
    lookupForm.reset();

  } catch (err) {
    alert("L·ªói g·ª≠i d·ªØ li·ªáu: " + err.message);
  }
});
</script>
