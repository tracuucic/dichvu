<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEAM NG·ªåC TR√ÇN - MAFC</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">

  <style>
    .avatar-green {
      background: linear-gradient(135deg, #16a34a, #34d399);
    }
    .card { background: #ffffff; }

    .notif-bell {
      position: relative;
      cursor: pointer;
      display: inline-block;
      font-size: 24px;
    }
    .notif-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 18px;
      height: 18px;
      text-align: center;
      border-radius: 50%;
      line-height: 18px;
    }

    .admin-content {
      transition: max-height 0.3s ease;
      overflow: hidden;
    }

    #loginNotifBox { display: none !important; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 md:py-4 flex items-center justify-between gap-4">

      <div class="flex items-center gap-3">
        <div class="w-9 h-9 md:w-10 md:h-10 rounded-md avatar-green flex items-center justify-center text-white font-semibold text-sm">
          MAFC
        </div>

        <div>
          <div class="text-base md:text-lg font-semibold">TRANG H·ªñ TR·ª¢ CHECK B11</div>
          <div class="text-xs text-gray-500">Gi·∫£i Ph√°p T·∫°m Th·ªùi - 0901450505 Ms.Tr√¢n</div>
        </div>
      </div>

      <div id="headerRight" class="text-sm text-gray-600 truncate max-w-xs md:max-w-md text-right">
        <span id="notifBell" class="notif-bell">
          üîî<span id="notifCount" class="notif-count">0</span>
        </span>
      </div>

    </div>
  </header>

  <!-- LAYOUT -->
  <div class="min-h-[calc(100vh-72px)] max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-8 flex flex-col md:flex-row gap-6 md:gap-8">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white border rounded-lg p-4 md:p-6 flex-shrink-0">
      <div class="flex items-center gap-3 mb-4 md:mb-6">

        <div id="sidebarAvatar"
             class="w-10 h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">?</div>

        <div class="min-w-0">
          <div id="sidebarName" class="font-semibold truncate">---</div>
          <div id="sidebarEmail" class="text-xs text-gray-500 truncate">---</div>
        </div>

      </div>

      <!-- MENU -->
      <nav class="space-y-2">
        <button id="navLookup"
          class="w-full text-left px-3 py-2 rounded-md bg-green-50 text-green-700 flex items-center gap-3">
          üîç Tra c·ª©u CIC
        </button>

        <button id="navHistory"
          class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üìú L·ªãch s·ª≠ tra c·ª©u
        </button>

        <button id="navApprove"
          class="hidden w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üë• Duy·ªát t√†i kho·∫£n
        </button>

        <button id="navAdmin"
          class="hidden w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 flex items-center gap-3">
          üõ°Ô∏è Trang Admin
        </button>
      </nav>

      <div class="mt-4 border-t pt-3">
        <button id="btnEditName"
          class="w-full text-left text-sm mb-2 px-2 py-2 rounded-md hover:bg-gray-100">
          ‚úèÔ∏è C·∫≠p nh·∫≠t h·ªç t√™n
        </button>

        <button id="btnLogout"
          class="w-full text-left text-sm text-red-600 px-2 py-2 rounded-md hover:bg-red-50">
          üö™ ƒêƒÉng xu·∫•t
        </button>
      </div>
    </aside>
    <!-- MAIN CONTENT -->
    <main class="flex-1">

      <!-- AUTH BOX -->
      <section id="authBox" class="mx-auto card rounded-lg shadow p-4 md:p-6 max-w-lg">
        <div id="authForms">

          <!-- SIGNUP -->
          <div id="signupArea">
            <h3 class="text-lg md:text-xl font-semibold mb-3">ƒêƒÉng k√Ω t√†i kho·∫£n</h3>

            <form id="signupForm" class="space-y-2">
              <input id="signupName" class="w-full border rounded-md px-3 py-2"
                     placeholder="H·ªç t√™n nh√¢n vi√™n" required />

              <input id="signupEmail" type="email" class="w-full border rounded-md px-3 py-2"
                     placeholder="Email" required />

              <input id="signupPass" type="password" class="w-full border rounded-md px-3 py-2"
                     placeholder="M·∫≠t kh·∫©u" required />

              <input id="signupRepass" type="password" class="w-full border rounded-md px-3 py-2"
                     placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit"
                        class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md">
                  ƒêƒÉng k√Ω
                </button>

                <button id="showLoginBtn"
                        class="flex-1 border rounded-md px-4 py-2">
                  ƒê√£ c√≥ t√†i kho·∫£n
                </button>
              </div>
            </form>
          </div>

          <!-- LOGIN -->
          <div id="loginArea" class="hidden">
            <h3 class="text-lg md:text-xl font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>

            <form id="loginForm" class="space-y-2">
              <input id="loginEmail" type="email" class="w-full border rounded-md px-3 py-2"
                     placeholder="Email" required />

              <input id="loginPass" type="password" class="w-full border rounded-md px-3 py-2"
                     placeholder="M·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit"
                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md">
                  ƒêƒÉng nh·∫≠p
                </button>

                <button id="showSignupBtn"
                        class="flex-1 border rounded-md px-4 py-2">
                  ƒêƒÉng k√Ω
                </button>
              </div>
            </form>
          </div>

        </div>
      </section>



      <!-- APP AREA -->
      <section id="appArea" class="hidden space-y-6">



        <!-- LOOKUP PAGE -->
        <div id="lookupPage" class="card rounded-lg p-4 md:p-6">

          <div class="mb-4 text-red-600 font-bold text-xs">
            üì¢ L∆∞u √Ω tra c·ª©u B11:<br>
            ‚Ä¢ Nh·∫≠p ƒë√∫ng h·ªç t√™n KH v√† CCCD 12 s·ªë.<br>
            ‚Ä¢ Kh√¥ng h·ªó tr·ª£ s·ªë CMND 9 s·ªë.<br>
            ‚Ä¢ K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã trong m·ª•c ‚ÄúL·ªãch s·ª≠ tra c·ª©u‚Äù.
          </div>

          <h3 class="text-lg font-semibold mb-4">üîé G·ª≠i y√™u c·∫ßu tra c·ª©u B11</h3>

          <form id="lookupForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">

            <div class="md:col-span-7">
              <label class="text-sm text-gray-600">H·ªç v√† t√™n kh√°ch h√†ng</label>
              <input id="fullname" class="w-full border rounded-md px-3 py-2" required />
            </div>

            <div class="md:col-span-5">
              <label class="text-sm text-gray-600">S·ªë CCCD (12 s·ªë)</label>
              <input id="cccd" maxlength="12" class="w-full border rounded-md px-3 py-2" required />
            </div>

            <div class="md:col-span-12">
              <button type="submit"
                      class="bg-green-600 text-white px-5 py-2 rounded-md w-full md:w-auto">
                G·ª≠i tra c·ª©u
              </button>
            </div>

          </form>

          <div id="lookupResult" class="mt-4 text-sm text-gray-700">
            Ch∆∞a c√≥ k·∫øt qu·∫£.
          </div>

        </div>



        <!-- HISTORY PAGE -->
        <div id="historyPage" class="card rounded-lg p-4 md:p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">üìú L·ªãch s·ª≠ tra c·ª©u c·ªßa b·∫°n</h3>

          <div id="historyList" class="space-y-2 text-sm text-gray-700">
            Ch∆∞a c√≥ l·ªãch s·ª≠.
          </div>

        </div>



        <!-- APPROVE USERS PAGE -->
        <div id="approvePage" class="card rounded-lg p-4 md:p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">üë• Duy·ªát t√†i kho·∫£n nh√¢n vi√™n</h3>

          <table class="w-full text-sm border">
            <thead>
              <tr class="bg-gray-100 border">
                <th class="px-2 py-1 border">H·ªç t√™n</th>
                <th class="px-2 py-1 border">Email</th>
                <th class="px-2 py-1 border">Duy·ªát</th>
                <th class="px-2 py-1 border">X√≥a</th>
              </tr>
            </thead>
            <tbody id="approveList">
              <tr><td colspan="4" class="text-center py-2 text-gray-500">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>

        </div>



        <!-- ADMIN PAGE -->
        <div id="adminPage" class="card rounded-lg p-4 md:p-6 hidden">

          <h3 class="text-xl font-semibold mb-4">üõ°Ô∏è TRANG ADMIN ‚Äì TR·∫¢ K·∫æT QU·∫¢ CIC</h3>

          <div id="adminList" class="space-y-4 text-sm text-gray-700">
            ƒêang t·∫£i d·ªØ li·ªáu...
          </div>

        </div>

      </section>

    </main>
  </div>



  <!-- MODAL UPDATE NAME -->
  <div id="updateNameBox"
       class="fixed right-4 bottom-4 md:right-6 md:bottom-6 hidden z-50">
    <div class="bg-white p-3 rounded-lg shadow w-64">

      <div class="mb-2 text-sm font-medium">C·∫≠p nh·∫≠t h·ªç t√™n</div>

      <input id="updateNameInput"
             class="w-full border rounded-md px-3 py-2 mb-2"
             placeholder="H·ªç v√† t√™n m·ªõi" />

      <div class="flex gap-2">
        <button id="saveNameBtn"
                class="bg-green-600 text-white px-3 py-1 rounded-md">
          L∆∞u
        </button>

        <button id="cancelNameBtn"
                class="border px-3 py-1 rounded-md">
          H·ªßy
        </button>
      </div>

    </div>
  </div>



  <!-- FOOTER -->
  <footer class="mt-6 md:mt-8">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-4 text-center text-sm text-gray-500 border-t bg-white">
      ¬© Copyright 2025 Thi·∫øt k·∫ø b·ªüi Ms.Tr√¢n
    </div>
  </footer>
<!-- FIREBASE COMPAT SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============================================================
    FIREBASE CONFIG
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDyksVWuBPVVbHix7u-OZmIh8nFu66uNFo",
  authDomain: "tracuucic-login.firebaseapp.com",
  projectId: "tracuucic-login",
  storageBucket: "tracuucic-login.appspot.com",
  messagingSenderId: "648747772689",
  appId: "1:648747772689:web:69da6e1534ed63efddbab0",
};

/* ============================================================
    INIT FIREBASE
============================================================ */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ============================================================
    DOM ELEMENTS
============================================================ */
const authBox      = document.getElementById("authBox");
const signupArea   = document.getElementById("signupArea");
const loginArea    = document.getElementById("loginArea");

const sidebarName  = document.getElementById("sidebarName");
const sidebarEmail = document.getElementById("sidebarEmail");
const sidebarAvatar = document.getElementById("sidebarAvatar");

const updateNameBox   = document.getElementById("updateNameBox");
const updateNameInput = document.getElementById("updateNameInput");
const saveNameBtn     = document.getElementById("saveNameBtn");
const cancelNameBtn   = document.getElementById("cancelNameBtn");

const navLookup  = document.getElementById("navLookup");
const navHistory = document.getElementById("navHistory");
const navAdmin   = document.getElementById("navAdmin");
const approveList = document.getElementById("approveList");

const lookupPage  = document.getElementById("lookupPage");
const historyPage = document.getElementById("historyPage");
const adminPage   = document.getElementById("adminPage");
const approvePage = document.getElementById("approvePage");

const historyList = document.getElementById("historyList");
const adminList   = document.getElementById("adminList");

const notifBell  = document.getElementById("notifBell");
const notifCount = document.getElementById("notifCount");

const lookupResult = document.getElementById("lookupResult");

/* ============================================================
    ADMIN EMAIL
============================================================ */
const ADMIN_EMAIL = "vothienbdn@gmail.com";

function isAdmin(user) {
  return user && user.email === ADMIN_EMAIL;
}

/* ============================================================
    SWITCH LOGIN <-> SIGNUP
============================================================ */
document.getElementById("showLoginBtn").addEventListener("click", e => {
  e.preventDefault();
  signupArea.classList.add("hidden");
  loginArea.classList.remove("hidden");
});

document.getElementById("showSignupBtn").addEventListener("click", e => {
  e.preventDefault();
  loginArea.classList.add("hidden");
  signupArea.classList.remove("hidden");
});
/* ============================================================
    SIGNUP ACCOUNT (TH√äM C∆† CH·∫æ CH·ªú DUY·ªÜT)
============================================================ */
document.getElementById("signupForm").addEventListener("submit", async e => {
  e.preventDefault();

  const name   = signupName.value.trim();
  const email  = signupEmail.value.trim();
  const pass   = signupPass.value;
  const repass = signupRepass.value;

  if (!name || !email || !pass) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!");

  if (pass !== repass) return alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!");

  try {
    // T·∫°o user auth
    const userCred = await auth.createUserWithEmailAndPassword(email, pass);

    await userCred.user.updateProfile({ displayName: name });

    // L∆∞u v√†o danh s√°ch ch·ªù duy·ªát
    await db.collection("users_pending").doc(userCred.user.uid).set({
      uid: userCred.user.uid,
      name,
      email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù admin duy·ªát t√†i kho·∫£n.");

    await auth.signOut();

    signupForm.reset();
    signupArea.classList.add("hidden");
    loginArea.classList.remove("hidden");

  } catch (err) {
    alert("L·ªói ƒëƒÉng k√Ω: " + err.message);
  }
});



/* ============================================================
    LOGIN ACCOUNT (KI·ªÇM TRA TR·∫†NG TH√ÅI DUY·ªÜT)
============================================================ */
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();

  const email = loginEmail.value.trim();
  const pass  = loginPass.value;

  try {
    const loginResult = await auth.signInWithEmailAndPassword(email, pass);

    const user = loginResult.user;

    // N·∫øu user l√† admin ‚Üí cho v√†o lu√¥n
    if (isAdmin(user)) return;

    // Ki·ªÉm tra xem user ƒë√£ ƒë∆∞·ª£c duy·ªát ch∆∞a
    const approvedDoc = await db.collection("approved_users").doc(user.uid).get();

    if (!approvedDoc.exists) {
      alert("T√†i kho·∫£n c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c admin duy·ªát!");
      await auth.signOut();
      return;
    }

    // Cho ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng

  } catch (err) {
    alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
  }
});
/* ============================================================
    ADMIN ‚Äî LOAD DANH S√ÅCH USER CH·ªú DUY·ªÜT
============================================================ */
let unsubApprove = null;

function startApproveListener() {
  const user = auth.currentUser;
  if (!isAdmin(user)) return;

  if (unsubApprove) unsubApprove();

  unsubApprove = db.collection("users_pending")
    .orderBy("createdAt", "asc")
    .onSnapshot(snapshot => {
      approveList.innerHTML = "";

      if (snapshot.empty) {
        approveList.innerHTML =
          `<tr><td colspan="4" class="text-center py-2 text-gray-400">
             Kh√¥ng c√≥ t√†i kho·∫£n ƒëang ch·ªù duy·ªát
           </td></tr>`;
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();

        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="border px-2 py-1">${data.name}</td>
          <td class="border px-2 py-1">${data.email}</td>

          <td class="border px-2 py-1 text-center">
            <button class="approveBtn bg-green-600 text-white px-3 py-1 rounded text-xs"
                    data-id="${data.uid}" data-name="${data.name}" data-email="${data.email}">
              ‚úì Duy·ªát
            </button>
          </td>

          <td class="border px-2 py-1 text-center">
            <button class="denyBtn bg-red-600 text-white px-3 py-1 rounded text-xs"
                    data-id="${data.uid}">
              ‚úï X√≥a
            </button>
          </td>
        `;

        approveList.appendChild(row);
      });

      attachApproveEvents();
    });
}



/* ============================================================
    ADMIN ‚Äî EVENT DUY·ªÜT & XO√Å USER PENDING
============================================================ */
function attachApproveEvents() {

  /* =======================
      DUY·ªÜT USER
  ======================== */
  document.querySelectorAll(".approveBtn").forEach(btn => {
    btn.onclick = async () => {
      const uid = btn.getAttribute("data-id");
      const name = btn.getAttribute("data-name");
      const email = btn.getAttribute("data-email");

      if (!confirm(`Duy·ªát t√†i kho·∫£n:\n${name}\n${email}?`)) return;

      try {
        // Th√™m v√†o danh s√°ch ƒë√£ duy·ªát
        await db.collection("approved_users").doc(uid).set({
          uid, name, email,
          approvedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Xo√° kh·ªèi danh s√°ch ch·ªù duy·ªát
        await db.collection("users_pending").doc(uid).delete();

        alert("ƒê√£ duy·ªát t√†i kho·∫£n!");
      } catch (e) {
        alert("L·ªói duy·ªát: " + e.message);
      }
    };
  });



  /* =======================
      XO√Å USER PENDING
  ======================== */
  document.querySelectorAll(".denyBtn").forEach(btn => {
    btn.onclick = async () => {
      const uid = btn.getAttribute("data-id");

      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° t√†i kho·∫£n n√†y?")) return;

      try {
        await db.collection("users_pending").doc(uid).delete();
        alert("ƒê√£ xo√° t√†i kho·∫£n ch·ªù duy·ªát.");
      } catch (e) {
        alert("L·ªói xo√°: " + e.message);
      }
    };
  });
}
/* ============================================================
    ADMIN ‚Äî LOAD Y√äU C·∫¶U B11 (REALTIME)
============================================================ */
let unsubAdmin = null;

function startAdminListener() {
  const user = auth.currentUser;
  if (!isAdmin(user)) return;

  if (unsubAdmin) unsubAdmin();

  unsubAdmin = db.collection("tra_cuu_b11")
    .orderBy("createdAt", "desc")
    .limit(300)
    .onSnapshot(snapshot => {
      
      adminList.innerHTML = "";

      snapshot.forEach(doc => {
        const item = doc.data();
        const id = doc.id;

        const time = item.createdAt?.toDate()?.toLocaleString() || "";
        const hasResult = item.ketQua && Object.keys(item.ketQua).length > 0;

        const block = document.createElement("div");
        block.className = "border rounded-lg p-3 bg-white";

        block.innerHTML = `

          <!-- N√∫t accordion -->
          <button class="w-full text-left font-semibold text-lg mb-2 flex justify-between items-center admin-toggle">
            ${item.customerName}
            ${hasResult ? "‚úÖ" : "‚è≥"}
          </button>

          <!-- N·ªôi dung accordion -->
          <div class="admin-content max-h-0 overflow-hidden">

            <div class="text-sm text-gray-600 mb-1">
              CCCD: ${item.cccd} ‚Äî ${time}
            </div>

            <div class="text-sm text-gray-500 mb-3">
              Nh√¢n vi√™n g·ª≠i: ${item.employeeName} ‚Ä¢ ${item.employeeEmail}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

              <div>
                <label class="text-sm font-semibold">Quan h·ªá TCTD</label>
                <input data-id="${id}" data-field="tctd"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.tctd || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">N·ª£ x·∫•u</label>
                <input data-id="${id}" data-field="noXau"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.noXau || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">N·ª£ ch√∫ √Ω</label>
                <input data-id="${id}" data-field="noChuY"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.noChuY || ""}">
              </div>

              <div>
                <label class="text-sm font-semibold">T·ªïng d∆∞ n·ª£</label>
                <input data-id="${id}" data-field="tongDuNo"
                       class="admin-input w-full border px-3 py-2 rounded"
                       value="${item.ketQua?.tongDuNo || ""}">
              </div>

              <div class="md:col-span-2">
                <label class="text-sm font-semibold">Ghi ch√∫</label>
                <textarea data-id="${id}" data-field="ghiChu"
                          class="admin-input w-full border px-3 py-2 rounded"
                >${item.ketQua?.ghiChu || ""}</textarea>
              </div>

            </div>

            <button data-save="${id}"
                    class="saveKetQua mt-4 bg-green-600 text-white px-4 py-2 rounded">
              üíæ L∆∞u k·∫øt qu·∫£ & ho√†n t·∫•t
            </button>

          </div>
        `;

        adminList.appendChild(block);
      });

      attachAdminAccordion();
      attachAdminSaveEvents();
    });
}



/* ============================================================
    ADMIN ‚Äî Accordion m·ªü r·ªông n·ªôi dung
============================================================ */
function attachAdminAccordion() {
  document.querySelectorAll(".admin-toggle").forEach(btn => {
    btn.onclick = () => {
      const content = btn.nextElementSibling;

      if (content.style.maxHeight) {
        content.style.maxHeight = null;
      } else {
        content.style.maxHeight = content.scrollHeight + "px";
      }
    };
  });
}



/* ============================================================
    ADMIN ‚Äî L∆ØU K·∫æT QU·∫¢ CIC
============================================================ */
function attachAdminSaveEvents() {
  document.querySelectorAll(".saveKetQua").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-save");

      const inputs = document.querySelectorAll(`.admin-input[data-id="${id}"]`);

      const ketQua = {};
      inputs.forEach(ip => {
        const field = ip.getAttribute("data-field");
        ketQua[field] = ip.value.trim();
      });

      try {
        await db.collection("tra_cuu_b11").doc(id).update({ ketQua });
        alert("ƒê√£ l∆∞u k·∫øt qu·∫£ th√†nh c√¥ng!");

      } catch (err) {
        alert("L·ªói khi l∆∞u: " + err.message);
      }
    };
  });
}



/* ============================================================
    B·∫§M CHU√îNG ‚Äî m·ªü l·ªãch s·ª≠ + reset th√¥ng b√°o
============================================================ */
notifBell.onclick = () => {
  notifCount.textContent = "0";
  newNotifCount = 0;
  navHistory.click();
};



/* ============================================================
    AUTH STATE ‚Äî ƒêI·ªÄU KHI·ªÇN TO√ÄN H·ªÜ TH·ªêNG
============================================================ */
auth.onAuthStateChanged(async user => {

  if (user) {

    // Hi·ªán app, ·∫©n login
    authBox.classList.add("hidden");
    appArea.classList.remove("hidden");

    sidebarName.textContent = user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)";
    sidebarEmail.textContent = user.email;
    sidebarAvatar.textContent =
      (user.displayName || "?").charAt(0).toUpperCase();

    // ADMIN
    if (isAdmin(user)) {
      navAdmin.classList.remove("hidden");
      navApprove.classList.remove("hidden");

      startAdminListener();
      startApproveListener();

    } else {
      navAdmin.classList.add("hidden");
    }

    // RESET th√¥ng b√°o
    seenResultIDs.clear();
    newNotifCount = 0;
    notifCount.textContent = "0";

    // L·ªãch s·ª≠ nh√¢n vi√™n
    startHistoryListener();

  } else {

    // reset UI
    authBox.classList.remove("hidden");
    appArea.classList.add("hidden");

    sidebarName.textContent = "---";
    sidebarEmail.textContent = "---";
    sidebarAvatar.textContent = "?";
    notifCount.textContent = "0";

    if (unsubHistory) unsubHistory();
    if (unsubAdmin) unsubAdmin();
    if (unsubApprove) unsubApprove();
  }
});
