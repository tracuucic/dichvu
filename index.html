<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang T·ªïng H·ª£p</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">

  <style>
    .avatar-green { background: linear-gradient(135deg,#16a34a,#34d399); }
    .card { background: #ffffff; }
    .notif-bell {
      position: relative;
      cursor: pointer;
      display: inline-block;
      font-size: 24px;
    }
    .notif-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 18px;
      height: 18px;
      text-align: center;
      border-radius: 50%;
      line-height: 18px;
    }

    #loginNotifBox { display: none !important; }

    #tinhLaiPage iframe { border: 0; width: 100%; height: 100%; border-radius: 8px; }
    #tinhLaiPage { height: calc(100vh - 180px); min-height: 480px; }

    @media (max-width: 640px) {
      #tinhLaiPage { height: calc(100vh - 160px); }
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">MAFC</div>
        <div>
          <div class="text-lg font-semibold">TRANG T·ªîNG H·ª¢P</div>
          <div class="text-xs text-gray-500">Gi·∫£i Ph√°p T·∫°m Th·ªùi - Call:0964307247</div>
        </div>
      </div>

      <div id="headerRight" class="text-sm text-gray-600 truncate max-w-xs text-right">
        <span id="notifBell" class="notif-bell">üîî<span id="notifCount" class="notif-count">0</span></span>
      </div>
    </div>
  </header>

  <div class="min-h-[calc(100vh-72px)] max-w-6xl mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white border rounded-lg p-6">
      <div class="flex items-center gap-3 mb-6">
        <div id="sidebarAvatar" class="w-10 h-10 rounded-md avatar-green flex items-center justify-center text-white font-bold">?</div>
        <div>
          <div id="sidebarName" class="font-semibold truncate">---</div>
          <div id="sidebarEmail" class="text-xs text-gray-500 truncate">---</div>
        </div>
      </div>

      <nav class="space-y-2">
        <button id="navLookup" class="w-full text-left px-3 py-2 rounded-md bg-green-50 text-green-700">üîç Tra c·ª©u CIC</button>
        <button id="navHistory" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100">üìú L·ªãch s·ª≠ tra c·ª©u</button>

        <!-- N√öT ADMIN - ·∫®N ƒê·∫æN KHI ƒê√öNG ADMIN -->
        <button id="navAdmin" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 hidden">üõ°Ô∏è Trang Admin</button>

        <button id="navTinhLai" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100">üí∞ T√≠nh L√£i Su·∫•t</button>
      </nav>

      <div class="mt-4 border-t pt-3">
        <button id="btnEditName" class="w-full text-left text-sm mb-2 px-2 py-2 hover:bg-gray-100">‚úèÔ∏è C·∫≠p nh·∫≠t h·ªç t√™n</button>
        <button id="btnLogout" class="w-full text-left text-sm text-red-600 px-2 py-2 hover:bg-red-50">üö™ ƒêƒÉng xu·∫•t</button>
      </div>
    </aside>

    <!-- MAIN CONTENT (s·∫Ω g·ª≠i ph·∫ßn n√†y ·ªü PH·∫¶N 2) -->
    <!-- MAIN CONTENT -->
    <main class="flex-1">

      <!-- LOGIN / SIGNUP BOX -->
      <section id="authBox" class="mx-auto card rounded-lg shadow p-6 max-w-lg">
        <div id="authForms">

          <!-- SIGNUP -->
          <div id="signupArea">
            <h3 class="text-lg font-semibold mb-3">ƒêƒÉng k√Ω t√†i kho·∫£n</h3>
            <form id="signupForm" class="space-y-2">
              <input id="signupName" class="w-full border rounded-md px-3 py-2" placeholder="H·ªç t√™n nh√¢n vi√™n" required />
              <input id="signupEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email" required />
              <input id="signupPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="M·∫≠t kh·∫©u" required />
              <input id="signupRepass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md">ƒêƒÉng k√Ω</button>
                <button id="showLoginBtn" class="flex-1 border rounded-md px-4 py-2">ƒê√£ c√≥ t√†i kho·∫£n</button>
              </div>
            </form>
          </div>

          <!-- LOGIN -->
          <div id="loginArea" class="hidden">
            <h3 class="text-lg font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>
            <form id="loginForm" class="space-y-2">
              <input id="loginEmail" type="email" class="w-full border rounded-md px-3 py-2" placeholder="Email" required />
              <input id="loginPass" type="password" class="w-full border rounded-md px-3 py-2" placeholder="M·∫≠t kh·∫©u" required />

              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md">ƒêƒÉng nh·∫≠p</button>
                <button id="showSignupBtn" class="flex-1 border rounded-md px-4 py-2">ƒêƒÉng k√Ω</button>
              </div>
            </form>
          </div>

        </div>
      </section>

      <!-- APP AREA -->
      <section id="appArea" class="hidden space-y-6">

        <!-- TRA C·ª®U PAGE -->
        <div id="lookupPage" class="card rounded-lg p-6">

          <div class="mb-4 text-red-600 font-bold text-xs">
            üì¢ Th√¥ng b√°o th·ªùi gian tra c·ª©u B11<br>
            Tra c·ª©u gi·ªù h√†nh ch√≠nh: k·∫øt qu·∫£ t·ª´ 30 ph√∫t ‚Äì 1 ti·∫øng<br>
            Vui l√≤ng ghi ch√≠nh x√°c h·ªç t√™n kh√°ch h√†ng, kh√¥ng check ƒë∆∞·ª£c CMND c≈©.<br>
            *** K·∫æT QU·∫¢ TRA C·ª®U HI·ªÇN TH·ªä ·ªû "L·ªãch S·ª≠ Tra C·ª©u" ***
          </div>

          <h3 class="text-lg font-semibold mb-4">üîé Tra c·ª©u B11</h3>

          <form id="lookupForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-7">
              <label class="text-sm text-gray-600">H·ªç v√† t√™n kh√°ch h√†ng</label>
              <input id="fullname" class="w-full border rounded-md px-3 py-2" placeholder="Nguy·ªÖn VƒÉn A" required />
            </div>

            <div class="md:col-span-5">
              <label class="text-sm text-gray-600">S·ªë CCCD (12 s·ªë)</label>
              <input id="cccd" maxlength="12" class="w-full border rounded-md px-3 py-2" placeholder="123456789012" required />
            </div>

            <div class="md:col-span-12">
              <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-md w-full md:w-auto">Tra c·ª©u</button>
            </div>
          </form>

          <div id="lookupResult" class="mt-4 text-sm text-gray-700">Ch∆∞a c√≥ k·∫øt qu·∫£.</div>

        </div>

        <!-- L·ªäCH S·ª¨ PAGE (NH√ÇN VI√äN) -->
        <div id="historyPage" class="card rounded-lg p-6 hidden">
          <h3 class="text-lg font-semibold mb-4">üìú L·ªãch s·ª≠ tra c·ª©u c·ªßa b·∫°n</h3>
          <div id="historyList" class="space-y-2 text-sm text-gray-700">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>
        </div>

        <!-- ADMIN PAGE (QU·∫¢N L√ù T·∫§T C·∫¢ TRA C·ª®U) -->
        <div id="adminPage" class="card rounded-lg p-6 hidden">
          <h3 class="text-xl font-semibold mb-4">üõ°Ô∏è Qu·∫£n l√Ω tra c·ª©u (ADMIN)</h3>
          <div id="adminList" class="space-y-4 text-sm text-gray-700">ƒêang t·∫£i...</div>
        </div>

        <!-- T√çNH L√ÉI PAGE -->
        <div id="tinhLaiPage" class="card rounded-lg p-0 hidden" style="height: calc(100vh - 120px);">
          <div class="flex items-center justify-between px-4 py-3 border-b">
            <h3 class="text-lg font-semibold">üí∞ T√≠nh L√£i Su·∫•t</h3>
            <button id="btnBackFromTinhLai" class="text-sm px-3 py-1 rounded-md border">‚¨Ö Quay l·∫°i</button>
          </div>

          <iframe 
            id="iframeTinhLai"
            src="https://miraeasset-mt.github.io/vaytieudung/"
            class="w-full h-full rounded-lg border-0">
          </iframe>
        </div>

      </section>

    </main>
  </div>

  <!-- FOOTER -->
  <footer class="mt-6">
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-sm text-gray-500 border-t bg-white">
      ¬© Copyright 2025 VQT. Gi·∫£i Ph√°p Vay Ti√™u D√πng Uy T√≠n & Linh Ho·∫°t
    </div>
  </footer>
<script type="module">
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

  import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
    signOut, updateProfile, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  import { 
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, 
    limit, onSnapshot, doc, getDoc, updateDoc, where 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


  /* ==========================
     FIREBASE CONFIG
  ========================== */
  const firebaseConfig = {
    apiKey: "AIzaSyDyksVWuBPVVbHix7u-OZmIh8nFu66uNFo",
    authDomain: "tracuucic-login.firebaseapp.com",
    projectId: "tracuucic-login",
    storageBucket: "tracuucic-login.firebasestorage.app",
    messagingSenderId: "648747772689",
    appId: "1:648747772689:web:69da6e1534ed63efddbab0",
    measurementId: "G-ELVGHX2GL4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  /* ==========================
     DOM ELEMENTS
  ========================== */
  const authBox = document.getElementById("authBox");
  const appArea = document.getElementById("appArea");

  const signupArea = document.getElementById("signupArea");
  const loginArea = document.getElementById("loginArea");

  const sidebarName = document.getElementById("sidebarName");
  const sidebarEmail = document.getElementById("sidebarEmail");

  const navLookup = document.getElementById("navLookup");
  const navHistory = document.getElementById("navHistory");
  const navAdmin = document.getElementById("navAdmin");
  const navTinhLai = document.getElementById("navTinhLai");

  const lookupPage = document.getElementById("lookupPage");
  const historyPage = document.getElementById("historyPage");
  const adminPage = document.getElementById("adminPage");
  const tinhLaiPage = document.getElementById("tinhLaiPage");

  const notifBell = document.getElementById("notifBell");
  const notifCount = document.getElementById("notifCount");

  let newNotifCount = 0;
  let lastSeen = new Set();
  let unsubscribeHistory = null;


  /* ==========================
     SHOW LOGIN / SIGNUP
  ========================== */
  document.getElementById("showLoginBtn").onclick = (e) => {
    e.preventDefault();
    signupArea.classList.add("hidden");
    loginArea.classList.remove("hidden");
  };

  document.getElementById("showSignupBtn").onclick = (e) => {
    e.preventDefault();
    signupArea.classList.remove("hidden");
    loginArea.classList.add("hidden");
  };


  /* ==========================
     SIGNUP
  ========================== */
  document.getElementById("signupForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("signupName").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const pass = document.getElementById("signupPass").value;
    const repass = document.getElementById("signupRepass").value;

    if (pass !== repass) return alert("M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp");

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(userCredential.user, { displayName: name });
      alert("ƒêƒÉng k√Ω th√†nh c√¥ng, vui l√≤ng ƒëƒÉng nh·∫≠p!");

      signupArea.classList.add("hidden");
      loginArea.classList.remove("hidden");
    } 
    catch (err) {
      alert("L·ªói ƒëƒÉng k√Ω: " + err.message);
    }
  });


  /* ==========================
     LOGIN
  ========================== */
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("loginEmail").value.trim();
    const pass = document.getElementById("loginPass").value;

    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } 
    catch (err) {
      alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
    }
  });


  /* ==========================
     LOGOUT
  ========================== */
  document.getElementById("btnLogout").onclick = async () => {
    await signOut(auth);
  };


  /* ==========================
     CHECK ADMIN ROLE
  ========================== */
  async function isAdmin(user) {
    if (!user) return false;

    // C·ªê ƒê·ªäNH ADMIN EMAIL THEO Y√äU C·∫¶U
    if (user.email === "thien.miraeasset@gmail.com") return true;

    return false;
  }


  /* ==========================
     AUTH STATE CHANGE
  ========================== */
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      authBox.classList.add("hidden");
      appArea.classList.remove("hidden");

      sidebarName.textContent = user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)";
      sidebarEmail.textContent = user.email;

      const adminStatus = await isAdmin(user);

      if (adminStatus) {
        navAdmin.classList.remove("hidden");
      } else {
        navAdmin.classList.add("hidden");
      }

      startEmployeeHistoryListener();
    } 
    else {
      appArea.classList.add("hidden");
      authBox.classList.remove("hidden");
    }
  });


  /* ==========================
     EMPLOYEE HISTORY LISTENER
  ========================== */
  function startEmployeeHistoryListener() {
    const user = auth.currentUser;
    if (!user) return;

    const q = query(
      collection(db, "tra_cuu_b11"),
      where("uid", "==", user.uid),
      orderBy("createdAt", "desc"),
      limit(100)
    );

    if (unsubscribeHistory) unsubscribeHistory();

    unsubscribeHistory = onSnapshot(q, (snapshot) => {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";

      if (snapshot.empty) {
        historyList.innerHTML = "<div>Ch∆∞a c√≥ l·ªãch s·ª≠ tra c·ª©u.</div>";
        return;
      }

      snapshot.forEach((docu) => {
        const d = docu.data();
        const t = d.createdAt?.toDate?.().toLocaleString() || "";

        const el = document.createElement("div");
        el.className = "p-3 border rounded-md";

        el.innerHTML = `
          <div class="font-medium">${d.customerName}</div>
          <div class="text-xs text-gray-500">CCCD: ${d.cccd} ‚Äî ${t}</div>

          <div class="mt-1 text-sm text-blue-700 font-medium">K·∫øt qu·∫£ tra c·ª©u:</div>
          <div class="text-xs text-gray-700 ml-2">
            TCTD: ${d.ketQua?.tctd || "‚Äî"}<br>
            N·ª£ x·∫•u: ${d.ketQua?.noXau || "‚Äî"}<br>
            N·ª£ ch√∫ √Ω: ${d.ketQua?.noChuY || "‚Äî"}<br>
            T·ªïng d∆∞ n·ª£: ${d.ketQua?.tongDuNo || "‚Äî"}<br>
            Ghi ch√∫: ${d.ketQua?.ghiChu || "‚Äî"}
          </div>
        `;

        historyList.appendChild(el);

        if (d.ketQua && !lastSeen.has(docu.id)) {
          lastSeen.add(docu.id);
          newNotifCount++;
          notifCount.textContent = newNotifCount;
        }
      });
    });
  }


  /* ==========================
     NOTIFICATION BELL
  ========================== */
  notifBell.onclick = () => {
    newNotifCount = 0;
    notifCount.textContent = "0";

    lookupPage.classList.add("hidden");
    historyPage.classList.remove("hidden");
    adminPage.classList.add("hidden");
    tinhLaiPage.classList.add("hidden");
  };


  /* ==========================
     NAVIGATION
  ========================== */
  navLookup.onclick = () => {
    lookupPage.classList.remove("hidden");
    historyPage.classList.add("hidden");
    adminPage.classList.add("hidden");
    tinhLaiPage.classList.add("hidden");
  };

  navHistory.onclick = () => {
    lookupPage.classList.add("hidden");
    historyPage.classList.remove("hidden");
    adminPage.classList.add("hidden");
    tinhLaiPage.classList.add("hidden");
  };

  navTinhLai.onclick = () => {
    lookupPage.classList.add("hidden");
    historyPage.classList.add("hidden");
    adminPage.classList.add("hidden");
    tinhLaiPage.classList.remove("hidden");
  };

  document.getElementById("btnBackFromTinhLai").onclick = () => {
    tinhLaiPage.classList.add("hidden");
    lookupPage.classList.remove("hidden");
  };

  navAdmin.onclick = () => {
    lookupPage.classList.add("hidden");
    historyPage.classList.add("hidden");
    adminPage.classList.remove("hidden");
    tinhLaiPage.classList.add("hidden");
    startAdminListener();
  };


  /* ==========================
     ADMIN LISTENER
  ========================== */
  function startAdminListener() {
    const q = query(
      collection(db, "tra_cuu_b11"),
      orderBy("createdAt", "desc"),
      limit(200)
    );

    onSnapshot(q, (snapshot) => {
      const adminList = document.getElementById("adminList");
      adminList.innerHTML = "";

      snapshot.forEach((docu) => {
        const d = docu.data();
        const id = docu.id;
        const t = d.createdAt?.toDate?.().toLocaleString() || "";

        const el = document.createElement("div");
        el.className = "p-4 border rounded-lg";

        el.innerHTML = `
          <div class="font-medium text-lg">${d.customerName}</div>
          <div class="text-xs text-gray-500">CCCD: ${d.cccd} ‚Äî ${t}</div>
          <div class="text-xs text-gray-400 mb-2">Nh√¢n vi√™n: ${d.employeeName} ‚Ä¢ ${d.employeeEmail}</div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

            <div>
              <label class="text-xs">Hi·ªán ƒëang quan h·ªá t·∫°i TCTD</label>
              <input id="tctd_${id}" class="border rounded-md px-2 py-1 w-full" 
                     value="${d.ketQua?.tctd || ""}">
            </div>

            <div>
              <label class="text-xs">Hi·ªán ƒëang n·ª£ x·∫•u</label>
              <input id="noxau_${id}" class="border rounded-md px-2 py-1 w-full" 
                     value="${d.ketQua?.noXau || ""}">
            </div>

            <div>
              <label class="text-xs">Hi·ªán ƒëang n·ª£ ch√∫ √Ω</label>
              <input id="nochuy_${id}" class="border rounded-md px-2 py-1 w-full" 
                     value="${d.ketQua?.noChuY || ""}">
            </div>

            <div>
              <label class="text-xs">T·ªïng d∆∞ n·ª£</label>
              <input id="tongduno_${id}" class="border rounded-md px-2 py-1 w-full" 
                     value="${d.ketQua?.tongDuNo || ""}">
            </div>

          </div>

          <div class="mt-2">
            <label class="text-xs">Ghi ch√∫ kh√°c</label>
            <textarea id="ghichu_${id}" class="border rounded-md px-2 py-1 w-full" rows="2">${d.ketQua?.ghiChu || ""}</textarea>
          </div>

          <button onclick="saveKetQua('${id}')" 
            class="mt-3 bg-green-600 text-white px-4 py-2 rounded-md text-sm">
            üíæ L∆∞u k·∫øt qu·∫£
          </button>
        `;

        adminList.appendChild(el);
      });
    });
  }


  /* ==========================
     SAVE ADMIN RESULT
  ========================== */
  window.saveKetQua = async (id) => {
    const tctd = document.getElementById(`tctd_${id}`).value.trim();
    const noXau = document.getElementById(`noxau_${id}`).value.trim();
    const noChuY = document.getElementById(`nochuy_${id}`).value.trim();
    const tongDuNo = document.getElementById(`tongduno_${id}`).value.trim();
    const ghiChu = document.getElementById(`ghichu_${id}`).value.trim();

    try {
      await updateDoc(doc(db, "tra_cuu_b11", id), {
        ketQua: { tctd, noXau, noChuY, tongDuNo, ghiChu }
      });

      alert("ƒê√£ l∆∞u k·∫øt qu·∫£!");
    }
    catch (err) {
      alert("L·ªói khi l∆∞u: " + err.message);
    }
  };


  /* ==========================
     SUBMIT TRA C·ª®U (NV)
  ========================== */
  document.getElementById("lookupForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const customerName = document.getElementById("fullname").value.trim();
    const cccd = document.getElementById("cccd").value.trim();

    if (cccd.length !== 12) return alert("CCCD ph·∫£i ƒë·ªß 12 s·ªë");

    const user = auth.currentUser;
    if (!user) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");

    try {
      await addDoc(collection(db, "tra_cuu_b11"), {
        uid: user.uid,
        customerName,
        cccd,
        employeeName: user.displayName || "(Ch∆∞a c·∫≠p nh·∫≠t)",
        employeeEmail: user.email,
        ketQua: {},
        createdAt: serverTimestamp()
      });

      document.getElementById("lookupResult").innerHTML =
        `<span class="text-green-600 font-semibold">ƒê√£ g·ª≠i tra c·ª©u th√†nh c√¥ng!</span>`;

      document.getElementById("lookupForm").reset();
    }
    catch (err) {
      alert("L·ªói g·ª≠i tra c·ª©u: " + err.message);
    }
  });

</script>
